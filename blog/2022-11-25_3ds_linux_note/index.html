<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.20">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="工程屍 FlyPie 的異想世界 RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="工程屍 FlyPie 的異想世界 Atom Feed">
<link rel="alternate" type="application/json" href="/blog/feed.json" title="工程屍 FlyPie 的異想世界 JSON Feed">




<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.24/dist/katex.min.css" integrity="sha384-odtC+0UGzzFL/6PNoE8rX/SPcQDXBJ+uRepguP4QkPCm2LBxH3FA3y+fKSiJ+AmM" crossorigin="anonymous"><title data-rh="true">3DS 刷 Linux 筆記 | 工程屍 FlyPie 的異想世界</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://flyskypie.github.io/blog/2022-11-25_3ds_linux_note"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:locale" content="zh_tw"><meta data-rh="true" property="og:title" content="3DS 刷 Linux 筆記 | 工程屍 FlyPie 的異想世界"><meta data-rh="true" name="description" content="刷 Linux"><meta data-rh="true" property="og:description" content="刷 Linux"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2022-11-25T00:00:00.000Z"><meta data-rh="true" property="article:author" content="https://github.com/FlySkyPie"><meta data-rh="true" property="article:tag" content="learning note,3ds"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://flyskypie.github.io/blog/2022-11-25_3ds_linux_note"><link data-rh="true" rel="alternate" href="https://flyskypie.github.io/blog/2022-11-25_3ds_linux_note" hreflang="en"><link data-rh="true" rel="alternate" href="https://flyskypie.github.io/blog/2022-11-25_3ds_linux_note" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.08941cdf.css">
<link rel="preload" href="/assets/js/runtime~main.357ed0f7.js" as="script">
<link rel="preload" href="/assets/js/main.d20f962f.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_W2Cr themedImage--dark_oUvU"></div><b class="navbar__title text--truncate"></b></a><a class="navbar__item navbar__link" href="/docs/the-key-of-huanche/">專案文件</a><a class="navbar__item navbar__link" href="/blogs">數位手記</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/FlySkyPie" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_S7eR colorModeToggle_vKtC"><button class="clean-btn toggleButton_rCf9 toggleButtonDisabled_Pu9x" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_v35p"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_nQuB"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_dLyj"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_TMXw thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_V4zb margin-bottom--md">Recent posts</div><ul class="sidebarItemList_uHd5 clean-list"><li class="sidebarItem_spIe"><a class="sidebarItemLink_eqrF" href="/blog/2023-08-07_webrtc-learning-note">WebRTC 學習筆記</a></li><li class="sidebarItem_spIe"><a class="sidebarItemLink_eqrF" href="/blog/2023-08-05_polis-progress">Polis 專案研究進度</a></li><li class="sidebarItem_spIe"><a class="sidebarItemLink_eqrF" href="/blog/2023-05-14_project-polis">Polis Project</a></li><li class="sidebarItem_spIe"><a class="sidebarItemLink_eqrF" href="/blog/2023-04-11_dependencies-in-cpp-project">在 C++ 專案中處理仰賴套件的幾種方式</a></li><li class="sidebarItem_spIe"><a class="sidebarItemLink_eqrF" href="/blog/2023-04-01_electron_learning_note_intro">Electron 學習筆記 - 概敘</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="blogPostTitle_rzP5" itemprop="headline">3DS 刷 Linux 筆記</h1><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2022-11-25T00:00:00.000Z" itemprop="datePublished">November 25, 2022</time> · <!-- -->7 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><a href="https://github.com/FlySkyPie" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars.githubusercontent.com/u/9475660" alt="Wei Ji"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/FlySkyPie" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Wei Ji</span></a></div><small class="avatar__subtitle" itemprop="description">閃亮症候群工程屍</small></div></div></div></div></header><div id="post-content" class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_mojV" id="刷-linux">刷 Linux<a class="hash-link" href="#刷-linux" title="Direct link to heading">​</a></h2><p>如果已經刷完 CFW，並且安裝 Luma3DS 的話，在 3DS 上跑起來並不會太困難，只要照著<a href="https://www.gamebrew.org/wiki/Linux_for_3DS" target="_blank" rel="noopener noreferrer">指示</a>下載檔案並放到 SD 卡內，接著從 Luma3DS 的 ChainLoader 開機就能成功進入 Linux 了。使用者為 <code>root</code> ，密碼為 <code>toor</code> 。</p><p>然而這個 Linux 的檔案系統是跑在 Ram Disk 上，並且預設不會掛載記憶卡，因此在系統內進行任何修改在開機之後都會消失。要把檔案弄進去的方法有兩種：</p><ol><li>將檔案放到 SD 卡內，並掛載 <code>/dev/vda1</code></li><li>將檔案放到開機映像檔 <code>zImage</code> 內</li></ol><p>其實單論我的目的是在 Linux 跑一個 Jvascript 程式，大可直接用掛載的方式處理，但是使用 3DS Linux 的觸控板打指令真的是一件頗麻煩的事情（包含掛載指令），如果可以預載並自動執行一些腳本免除我手動輸入的步驟是再好不過了。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="製作開機映像檔">製作開機映像檔<a class="hash-link" href="#製作開機映像檔" title="Direct link to heading">​</a></h2><p>在處理自動掛載以前，我們要知道如何把東西放進 <code>zImage</code> 內，這過程涉及兩個步驟：</p><ol><li>產生 <code>rootfs.cpio.gz</code></li><li>製作 <code>zImage</code></li></ol><h3 class="anchor anchorWithStickyNavbar_mojV" id="產生-rootfscpiogz">產生 <code>rootfs.cpio.gz</code><a class="hash-link" href="#產生-rootfscpiogz" title="Direct link to heading">​</a></h3><p>cpio 是 UNIX 作業系統的一個檔案備份程式及檔案格式<sup id="fnref-cpio-intro-b62f93"><a href="#fn-cpio-intro-b62f93" class="footnote-ref">cpio-intro</a></sup>。cpio 是一個比較古老的備份命令，也是用於磁帶機備份的工具，雖然如此現在許多時侯仍然需要使用這命令，例如製作系統內存映像檔時等。像是系統映像檔通常位於 /boot 中，文件名以 initrd 開頭。<sup id="fnref-cpio-command-b62f93"><a href="#fn-cpio-command-b62f93" class="footnote-ref">cpio-command</a></sup></p><p>因為它是基於磁帶的備份工具，因此無法直接替換掉該檔案裡面的特定文件，必須要把整個 cpio 解包進行編輯後再包回去。</p><p><a href="https://github.com/linux-3ds" target="_blank" rel="noopener noreferrer">linux-3ds</a> 的專案有提供一個樣板可以直接下載：</p><div class="language-shell codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-shell codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">wget</span><span class="token plain"> https://github.com/linux-3ds/buildroot/releases/download/latest/rootfs.cpio.gz</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>或是你也可以從 buildroot 自己 build ，Buildroot 是一個可高度客製化的嵌入式 Linux 映像檔生成工具。Buildroot很強大，也很容易上手使用。<sup id="fnref-buildroot-intro-b62f93"><a href="#fn-buildroot-intro-b62f93" class="footnote-ref">Buildroot-intro</a></sup> Linux 3DS 專案下有一個已經與先準備好相關設定的 <a href="https://github.com/linux-3ds/buildroot" target="_blank" rel="noopener noreferrer">buildroot fork</a>，照著<a href="https://github.com/linux-3ds/buildroot/wiki" target="_blank" rel="noopener noreferrer">指示</a>做一樣很快就能生成 <code>cpio</code> 檔了。</p><p>cpio 作為 initrd 的格式，而 initrd 的英文含義是 boot loader initialized RAM disk，就是由 boot loader 初始化的 RAM Disk。在 linux 核心啟動前， boot loader 會將儲存介質中的 initrd 檔案載入到記憶體，核心啟動時會在訪問真正的根檔案系統前先訪問該記憶體中的 initrd 檔案系統。在 boot loader 組態了 initrd 的情況下，核心啟動被分成了兩個階段，第一階段先執行 initrd檔案系統中的&quot;某個檔案&quot;，完成載入驅動模組等任務，第二階段才會執行真正的根檔案系統中的 /sbin/init 處理程序。<sup id="fnref-initrd-b62f93"><a href="#fn-initrd-b62f93" class="footnote-ref">initrd</a></sup></p><h3 class="anchor anchorWithStickyNavbar_mojV" id="編輯-cpio-檔">編輯 <code>cpio</code> 檔<a class="hash-link" href="#編輯-cpio-檔" title="Direct link to heading">​</a></h3><p>我寫了一個小腳本來處理解包、覆蓋、包回去的步驟，
只要把檔案放在 <code>original/rootfs.cpio</code>，
要覆蓋的檔案樹放在 <code>override/</code> 下。</p><div class="language-shell codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-shell codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token shebang important">#!/bin/bash</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">EXTRACT_TEMPD</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">mktemp -d</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">OUTPUT_TEMPD</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">mktemp -d</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">WORK_PATH</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable builtin class-name" style="color:#36acaa">pwd</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!</span><span class="token plain"> -e </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$EXTRACT_TEMPD</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token file-descriptor important">&amp;2</span><span class="token plain"> </span><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Failed to create temp directory&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin class-name">exit</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">fi</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">echo</span><span class="token plain"> Extract Path: </span><span class="token variable" style="color:#36acaa">${EXTRACT_TEMPD}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">echo</span><span class="token plain"> Output Path: </span><span class="token variable" style="color:#36acaa">${OUTPUT_TEMPD}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Extract and Archive again, /dev/console would missing</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">mkdir</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">${EXTRACT_TEMPD}</span><span class="token plain">/root</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">cd</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">${EXTRACT_TEMPD}</span><span class="token plain">/root</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cpio -idv </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">${WORK_PATH}</span><span class="token string" style="color:#e3116c">/original/rootfs.cpio&quot;</span><span class="token plain"> </span><span class="token operator file-descriptor important" style="color:#393A34">2</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">${EXTRACT_TEMPD}</span><span class="token plain">/log.txt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">cp</span><span class="token plain"> -rf </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">${WORK_PATH}</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain">/override/* ./</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#find . &gt; ${OUTPUT_TEMPD}/log-1.txt</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">find</span><span class="token plain"> </span><span class="token builtin class-name">.</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> cpio -ov -H newc </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">${OUTPUT_TEMPD}</span><span class="token plain">/rootfs.cpio </span><span class="token operator file-descriptor important" style="color:#393A34">2</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">${OUTPUT_TEMPD}</span><span class="token plain">/log.txt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">cd</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">${OUTPUT_TEMPD}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">gzip</span><span class="token plain"> -c rootfs.cpio </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> rootfs.cpio.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">chown</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">Normal-User</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> -R </span><span class="token variable" style="color:#36acaa">${OUTPUT_TEMPD}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">chgrp</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">Normal-User</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> -R </span><span class="token variable" style="color:#36acaa">${OUTPUT_TEMPD}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">chown</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">Normal-User</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> -R </span><span class="token variable" style="color:#36acaa">${EXTRACT_TEMPD}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">chgrp</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">Normal-User</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> -R </span><span class="token variable" style="color:#36acaa">${EXTRACT_TEMPD}</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>比如，編譯出來的程式會仰賴 <code>/usr/lib/ld-linux-armhf.so.3</code>，但是 linux 3ds 提供的 cpio 並沒有這個路徑，就可以在 <code>override/</code> 下加入：</p><div class="codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-text codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain">./usr/lib:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ld-linux-armhf.so.3 -&gt; ../lib/libc.so</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>記得執行操作的時候要有 root 權限，因為 <code>rootfs.cpio</code> 裡面有些檔案類型需要 root 才能新增。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="製作-zimage">製作 <code>zImage</code><a class="hash-link" href="#製作-zimage" title="Direct link to heading">​</a></h3><p>照著<a href="https://github.com/linux-3ds/linux/wiki" target="_blank" rel="noopener noreferrer">指引</a>安裝仰賴的函式庫、clone repo、把 <code>rootfs.cpio.gz</code> 放到專案目錄下，接著執行：</p><div class="language-shell codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-shell codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain">$ $ </span><span class="token assign-left variable" style="color:#36acaa">ARCH</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">arm </span><span class="token assign-left variable" style="color:#36acaa">CROSS_COMPILE</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">arm-linux-gnueabi- </span><span class="token function" style="color:#d73a49">make</span><span class="token plain"> -j</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">nproc</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"> nintendo3ds_defconfig all</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>它就會 build 出包含 <code>zImage</code> 在內，在 3DS 上跑起 Linux 需要的一些檔案。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="自動掛載">自動掛載<a class="hash-link" href="#自動掛載" title="Direct link to heading">​</a></h2><p>這個 Linux 並沒有諸如 systemd, rc.local 之類的高級玩意，倒是有這些東西：</p><div class="language-shell codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-shell codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">ls</span><span class="token plain"> /etc/init.d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rcK  rcS  S01syslogd  S02klogd  S02sysctl</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>/etc/init.d/rcS</code> 承擔 start 的功能 <code>/etc/init.d/rcK</code> 承擔 kill(stop) 的功能，會依序執行 <code>/etc/init.d/rcS/S(\d\d.*)</code>，很好理解。</p><p>於是我就做了一個 <code>/etc/init.d/S03sdmnt</code> 來自動掛載 SD 卡：</p><div class="language-shell codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-shell codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token shebang important">#!/bin/sh</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$1</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">start</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Mount SD card&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Mount SD card</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">mkdir</span><span class="token plain"> /mnt/sdcard</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">mount</span><span class="token plain"> /dev/vda1 /mnt/sdcard</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">stop</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Unmount SD card&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Todo</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Usage: /etc/init.d/S03sdmnt {start|stop}&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">exit</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">esac</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">exit</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="小結">小結<a class="hash-link" href="#小結" title="Direct link to heading">​</a></h2><p>研究到這裡，會發現 Chain Loading<sup id="fnref-chain_loading-b62f93"><a href="#fn-chain_loading-b62f93" class="footnote-ref">Chain_loading</a></sup> 的影子非常明顯：
刷進去的 boot9strap 會 boot Luma3DS；
Luma3DS 會從 <code>luma/payloads/</code> boot <code>firm_linux_loader.firm</code>；
<code>firm_linux_loader.firm</code> 再去 boot <code>arm9linuxfw.bin</code>；
<code>arm9linuxfw.bin</code> 再用 <code>zImage</code> 開機（？）</p><hr><p><a href="http://creativecommons.org/licenses/by-sa/4.0/" target="_blank" rel="noopener noreferrer"><img loading="lazy" src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png" alt="創用 CC 授權條款" class="img_E7b_"></a><br>
<!-- -->Wei Ji以<a href="http://creativecommons.org/licenses/by-sa/4.0/" target="_blank" rel="noopener noreferrer">創用CC 姓名標示-相同方式分享 4.0 國際 授權條款</a>釋出。</p><div class="footnotes"><hr><ol><li id="fn-cpio-intro-b62f93">Cpio - 維基百科，自由的百科全書. Retrieved 2022-11-25, from <a href="https://zh.wikipedia.org/zh-tw/Cpio" target="_blank" rel="noopener noreferrer">https://zh.wikipedia.org/zh-tw/Cpio</a><a href="#fnref-cpio-intro-b62f93" class="footnote-backref">↩</a></li><li id="fn-cpio-command-b62f93">會紅的 Linux 筆記: cpio指令. Retrieved 2022-11-25, from <a href="http://canred.blogspot.com/2013/04/cpio.html" target="_blank" rel="noopener noreferrer">http://canred.blogspot.com/2013/04/cpio.html</a><a href="#fnref-cpio-command-b62f93" class="footnote-backref">↩</a></li><li id="fn-buildroot-intro-b62f93">精通嵌入式Linux 第三章：Buildroot – LotLab. Retrieved 2022-11-25, from <a href="https://www.lotlab.org/2020/04/08/mastering-embedded-linux-part-3-buildroot/" target="_blank" rel="noopener noreferrer">https://www.lotlab.org/2020/04/08/mastering-embedded-linux-part-3-buildroot/</a><a href="#fnref-buildroot-intro-b62f93" class="footnote-backref">↩</a></li><li id="fn-initrd-b62f93">【Linux技術】Linux核心Initrd機制解析，核心更新步驟，grub組態說明-阿里雲開發者社區. Retrieved 2022-11-25, from <a href="https://developer.aliyun.com/article/445357" target="_blank" rel="noopener noreferrer">https://developer.aliyun.com/article/445357</a><a href="#fnref-initrd-b62f93" class="footnote-backref">↩</a></li><li id="fn-chain_loading-b62f93">Chain loading - Wikipedia. Retrieved 2022-11-25, from <a href="https://en.wikipedia.org/wiki/Chain_loading" target="_blank" rel="noopener noreferrer">https://en.wikipedia.org/wiki/Chain_loading</a><a href="#fnref-chain_loading-b62f93" class="footnote-backref">↩</a></li></ol></div></div><footer class="row docusaurus-mt-lg blogPostDetailsFull_h6_j"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/blog/tags/learning-note">learning note</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/blog/tags/3-ds">3ds</a></li></ul></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/blog/2022-11-25_3ds_hack_note"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">3DS 刷機筆記</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/blog/2022-06-18_hordes_auction_monitor"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">在 Hordes.io 實現市場監控 (Market Monitor)</div></a></nav></main><div class="col col--2"><div class="tableOfContents_cNA8 thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#刷-linux" class="table-of-contents__link toc-highlight">刷 Linux</a></li><li><a href="#製作開機映像檔" class="table-of-contents__link toc-highlight">製作開機映像檔</a><ul><li><a href="#產生-rootfscpiogz" class="table-of-contents__link toc-highlight">產生 <code>rootfs.cpio.gz</code></a></li><li><a href="#編輯-cpio-檔" class="table-of-contents__link toc-highlight">編輯 <code>cpio</code> 檔</a></li><li><a href="#製作-zimage" class="table-of-contents__link toc-highlight">製作 <code>zImage</code></a></li></ul></li><li><a href="#自動掛載" class="table-of-contents__link toc-highlight">自動掛載</a></li><li><a href="#小結" class="table-of-contents__link toc-highlight">小結</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 FlyPie (Wei Ji)</div></div></div></footer></div>
<script src="/assets/js/runtime~main.357ed0f7.js"></script>
<script src="/assets/js/main.d20f962f.js"></script>
</body>
</html>