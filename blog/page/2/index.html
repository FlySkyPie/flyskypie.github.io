<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-list-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.1.1">
<title data-rh="true">Blog | 工程屍 FlyPie 的異想世界</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://flyskypie.github.io/blog/page/2"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" property="og:type" content="website"><meta data-rh="true" property="og:locale" content="zh_tw"><meta data-rh="true" property="og:title" content="Blog | 工程屍 FlyPie 的異想世界"><meta data-rh="true" name="description" content="Blog"><meta data-rh="true" property="og:description" content="Blog"><meta data-rh="true" name="docusaurus_tag" content="blog_posts_list"><meta data-rh="true" name="docsearch:docusaurus_tag" content="blog_posts_list"><meta data-rh="true" property="og:image" content="https://i.imgur.com/YNYYp47.png"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://flyskypie.github.io/blog/page/2"><link data-rh="true" rel="alternate" href="https://flyskypie.github.io/blog/page/2" hreflang="en"><link data-rh="true" rel="alternate" href="https://flyskypie.github.io/blog/page/2" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="工程屍 FlyPie 的異想世界 RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="工程屍 FlyPie 的異想世界 Atom Feed">
<link rel="alternate" type="application/json" href="/blog/feed.json" title="工程屍 FlyPie 的異想世界 JSON Feed">




<link rel="alternate" type="application/rss+xml" href="/posts/rss.xml" title="工程屍 FlyPie 的異想世界 RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/posts/atom.xml" title="工程屍 FlyPie 的異想世界 Atom Feed">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.24/dist/katex.min.css" integrity="sha384-odtC+0UGzzFL/6PNoE8rX/SPcQDXBJ+uRepguP4QkPCm2LBxH3FA3y+fKSiJ+AmM" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.7cc1d85a.css">
<script src="/assets/js/runtime~main.d45b157a.js" defer="defer"></script>
<script src="/assets/js/main.0ab9387f.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_LBgp" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedComponent_yFA9 themedComponent--light_gNzW"><img src="/img/logo.svg" alt="My Site Logo" class="themedComponent_yFA9 themedComponent--dark_IRH4"></div><b class="navbar__title text--truncate"></b></a><a class="navbar__item navbar__link" href="/docs/the-key-of-huanche/">專案文件</a><a class="navbar__item navbar__link" href="/blogs">數位手記</a><a class="navbar__item navbar__link" href="/posts">廢文雜談</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/FlySkyPie" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_s2nU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_DonJ colorModeToggle_KBLq"><button class="clean-btn toggleButton_qwn5 toggleButtonDisabled_tRn_" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_bYdl"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_D9Q4"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Cbrq"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_GUBX"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_UgN6 thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_PkUw margin-bottom--md">Recent posts</div><ul class="sidebarItemList_HFnO clean-list"><li class="sidebarItem_NmoJ"><a class="sidebarItemLink_GF4N" href="/blog/2024-06-15_pocket-ai">Pocket AI 開箱</a></li><li class="sidebarItem_NmoJ"><a class="sidebarItemLink_GF4N" href="/blog/2024-06-09_from-javascript-to-python-paradigm-migration">從 Javascript 到 Python 的範式遷移 (Paradigm Migration)</a></li><li class="sidebarItem_NmoJ"><a class="sidebarItemLink_GF4N" href="/blog/2024-05-29_I-like-minecraft-but-its-might-no-the-way-you-think">我喜歡 Minecraft，不過可能不是一般人認知的那種</a></li><li class="sidebarItem_NmoJ"><a class="sidebarItemLink_GF4N" href="/blog/2024-05-26_polis-gpu-context-issue">關於 Polis 的 GPU Context 問題</a></li><li class="sidebarItem_NmoJ"><a class="sidebarItemLink_GF4N" href="/blog/2024-04-03_tiddlywiki-journey-3">我的 Tiddlywiki 之旅 - Kanban</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="https://schema.org/Blog"><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="https://schema.org/BlogPosting"><meta itemprop="description" content="前情提要"><header><h2 class="title_BVkY" itemprop="headline"><a itemprop="url" href="/blog/about-ecs-distributed-minecraft-rl-rbnn-bar-code-language">關於我想用 ECS 實作 Minecraft 以分散式架構運行並在其中用增強式學習訓練完全視覺化之遞迴布林類神經網路以產出二維條碼人造語言那檔事</a></h2><div class="container_sDB1 margin-vert--md"><time datetime="2023-10-07T00:00:00.000Z" itemprop="datePublished">October 7, 2023</time> · <!-- -->15 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_SrKl"><div class="avatar margin-bottom--sm"><a href="https://github.com/FlySkyPie" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars.githubusercontent.com/u/9475660" alt="Wei Ji" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/FlySkyPie" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Wei Ji</span></a></div><small class="avatar__subtitle" itemprop="description">閃亮症候群工程屍</small></div></div></div></div></header><div class="markdown" itemprop="articleBody">
<h2 class="anchor anchorWithStickyNavbar_mpuI" id="前情提要">前情提要<a href="#前情提要" class="hash-link" aria-label="Direct link to 前情提要" title="Direct link to 前情提要">​</a></h2>
<p>關於我的 Side Project 「環驅之鑰」其實是一個很複雜、很難三言兩語說清楚東西，試著用一些像是<a href="https://flyskypie.github.io/docs/the-key-of-huanche/" target="_blank" rel="noopener noreferrer">條目</a>的東西來解釋它，作為我現場跟其他人解釋的參考資料算是蠻方便的輔助，但是讓人自行閱讀一目了然似乎還是稍嫌不足。</p>
<p>於是我決定試試用其他方式向一個可能沒什麼背景知識的解釋我想做的東西：先把其中一個主線用輕小說一般標題展開，再根據其中的內容慢慢解釋。</p>
<h2 class="anchor anchorWithStickyNavbar_mpuI" id="ecs-entity-component-system">ECS (Entity Component System)<a href="#ecs-entity-component-system" class="hash-link" aria-label="Direct link to ECS (Entity Component System)" title="Direct link to ECS (Entity Component System)">​</a></h2>
<blockquote>
<p>關於我<strong>想用 ECS 實作 Minecraft</strong> 以分散式架構運行並在其中用增強式學習訓練完全視覺化之遞迴布林類神經網路以產出二維條碼人造語言那檔事</p>
</blockquote>
<p>ECS 是種軟體架構，鬥陣特攻 (Overwatch) 的團隊在遊戲上使用並且在 GDC 2017 中介紹而遊戲開發圈廣為人知，Unity3D 更在 2018 將 ECS 框架引入遊戲引擎中。它的核心概念是不使用原本流行的物件導向 (OOP, Object-oriented programming) 的軟體抽象化方式轉而使用資料導向 (Data Oriented)。</p>
<p>OOP 的邏輯是：把程式邏輯抽象化成一個一個的「物件」，然後透過「方法」去操作物件，隨著專案越來越複雜，這些物件通常會一層包一層。而 ECS 的邏輯是：把資料跟運算邏輯分離，Component 只有資料、Entity 是 Component 的索引、System 則不儲存狀態專注於運算邏輯。</p>
<p>關於 ECS 的介紹我就點到這裡為止，至於我想在專案中使用這種架構的原因源自 2018 年我試著寫一個 Minecraft <a href="https://youtu.be/vH0KOeijNeQ?si=NnObrN-XhnVk9zFc" target="_blank" rel="noopener noreferrer">插件</a>的時候經歷了非常痛苦的開發體驗，以我當時想修改的殭屍實體為例：</p>
<p><img decoding="async" loading="lazy" src="/assets/images/01_minecraft-npc-8ebe3b7b05f99bc5c9204aed503ae661.webp" width="873" height="496" class="img_RpFt"></p>
<p>Minecraft 裡充滿了多層繼承 (Multilevel Inheritance)，這使得釐清物件之間如何交互作用的認知負荷變得非常高，雪上加霜的是 Minecraft 插件源自逆向工程的產物，並不是所有變數和方法都是人類可讀的。</p>
<p>雖然當時體驗的困難並不是所有都是軟體架構造成的，然而後來我才知道這種開發風格在遊戲開發圈也算是很有爭議的主題之一，在知道 Minecraft 的程式碼有多難除錯，看著它那滿坑滿谷的 <a href="https://bugs.mojang.com/projects/MC/issues" target="_blank" rel="noopener noreferrer">Bug 清單</a>，當中不少還直接被標記「這個不會被修復」似乎也不奇怪了。</p>
<p>作為一個想開發類似於 Minecraft 這等高度複雜的沙盒開放世界遊戲的後進者，自然會想避免步上 Minecraft 的後塵，而 ECS 便是我目前優先考慮的架構。</p>
<h2 class="anchor anchorWithStickyNavbar_mpuI" id="分散式架構">分散式架構<a href="#分散式架構" class="hash-link" aria-label="Direct link to 分散式架構" title="Direct link to 分散式架構">​</a></h2>
<blockquote>
<p>關於我想用 ECS 實作 Minecraft <strong>以分散式架構運行</strong>並在其中用增強式學習訓練完全視覺化之遞迴布林類神經網路以產出二維條碼人造語言那檔事</p>
</blockquote>
<p>Minecraft 大部分的運算是在同一個執行緒 (Thread) 上完成的，這在 Minecraft 的圈子也算是很有名的特性，因為你不能單純拿著多核心處理器去架遊戲伺服器就很神奇的可以容納更多的玩家。</p>
<p>這限制源自於它的遊戲運算不能簡單的被化為獨立的任務並分配成平行運算，作為一個寫網站的工程師，我並沒有足夠的知識與經驗去設計一個多執行緒的架構或系統，但是作為一個 Web 工程師我知道一種叫做微服務 (Microservices) 的東西，那麼我何不把遊戲拆成一組 Microservices 叢集，使其成為一個方便水平擴充的系統。</p>
<h2 class="anchor anchorWithStickyNavbar_mpuI" id="增強式學習-rl-reinforcement-learning">增強式學習 (RL, Reinforcement learning)<a href="#增強式學習-rl-reinforcement-learning" class="hash-link" aria-label="Direct link to 增強式學習 (RL, Reinforcement learning)" title="Direct link to 增強式學習 (RL, Reinforcement learning)">​</a></h2>
<blockquote>
<p>關於我想用 ECS 實作 Minecraft 以分散式架構運行並在其中<strong>用增強式學習訓練</strong>完全視覺化之遞迴布林類神經網路以產出二維條碼人造語言那檔事</p>
</blockquote>
<p><img decoding="async" loading="lazy" alt="https://ictinstitute.nl/ai-machine-learning-and-neural-networks-explained/" src="/assets/images/02_ai-f629980bbc540947c35b61a08f06019a.webp" width="700" height="296" class="img_RpFt"></p>
<p>增強式學習是機器學習 (Machine Learning) 領域的一個子集（分支），相較於其他著重資料分析、統計之類的機器學習主題，RL 著重於玩家 (Agent) 與環境 (Environment) 互動 (Action/Observe)，透過獎勵 (Reward) 來最佳化策略 (Policy)。RL 可以說是「遊戲感」最重的機器學習分支。</p>
<h2 class="anchor anchorWithStickyNavbar_mpuI" id="遞迴布林類神經網路-rbnn-recurrent-boolean-neural-network">遞迴布林類神經網路 (RBNN, Recurrent Boolean Neural Network)<a href="#遞迴布林類神經網路-rbnn-recurrent-boolean-neural-network" class="hash-link" aria-label="Direct link to 遞迴布林類神經網路 (RBNN, Recurrent Boolean Neural Network)" title="Direct link to 遞迴布林類神經網路 (RBNN, Recurrent Boolean Neural Network)">​</a></h2>
<blockquote>
<p>關於我想用 ECS 實作 Minecraft 以分散式架構運行並在其中用增強式學習訓練完全視覺化之<strong>遞迴布林類神經網路</strong>以產出二維條碼人造語言那檔事</p>
</blockquote>
<p>人工智慧 (AI, Artificial Intelligence)與深度學習 (Deep Learning) 算是近幾年被用到爛大街的詞彙了，起因來自於一個被稱作類神經網路 (Neural Network) 的不新鮮的數學模型在晶片性能提昇以及算法改善的現代而終於獲得實用化，又因為 AlphaGo 在 2016 擊敗人 類棋手等事件而形成話題才終於進入大眾的視野。</p>
<p>而布林類神經網路 (BNN)<sup><a href="#user-content-fn-bnn-ce8ad3" id="user-content-fnref-bnn-ce8ad3" data-footnote-ref="true" aria-describedby="footnote-label">1</a></sup> 則是參考了類神經網路的設計，但是不使用實數而是使用布林代數的一種算法，這個選擇並不是基於性能或實用性考量，老實說因為不是使用實數體系的代數，因此不能用微積分作弊（倒傳遞算法 Backpropagation），也不能直接以類神經模型主流的方式用顯示卡加速運算。</p>
<p>而是一種基於哲學上的選擇，私以為「因為類神經網路是對人類神經元的數學建模，因此類神經網路是通往『通用型人工<strong>智慧</strong>』的道路」是一種身為人類的傲慢。如果基於二進制的電腦能夠產生「通用智慧」，那它應該回歸二進制運算的本質，即布林代數本身，而不是透過浮點數 (IEEE 754) 運算去模仿神經元，這種模仿終究只能得到偽物。</p>
<p>根據奧卡姆剃刀 (Occam&#x27;s razor)，簡單的解釋通常比較接近真理，因此我想嘗試這條用布林代數去探索的道路。</p>
<p>RBNN 單純是參考了遞迴類神經網路 (RNN) 加入了遞迴的要素使該演算法具備記憶性。</p>
<h2 class="anchor anchorWithStickyNavbar_mpuI" id="完全視覺化">完全視覺化<a href="#完全視覺化" class="hash-link" aria-label="Direct link to 完全視覺化" title="Direct link to 完全視覺化">​</a></h2>
<blockquote>
<p>關於我想用 ECS 實作 Minecraft 以分散式架構運行並在其中用增強式學習訓練<strong>完全視覺化</strong>之遞迴布林類神經網路以產出二維條碼人造語言那檔事</p>
</blockquote>
<p>拿 Minecraft 來做機器學習訓練 AI 的專案不少，不過它們並不是沈浸式 (Immersive Experience) 的。在 Minecraft 之中除了第一人稱視角 (PFV, First-person view) 之外還有大量基於滑鼠操作的 UX。</p>
<p>對增強式學習而言，玩家與環境的互動來自操作 (Action) 與觀察 (Observe)，對人類而言可以觀察到 Minecraft 的兩個資訊：第一人稱 3D 渲染與 HUD/UI；而操作同樣有兩個：第一人稱控制器與滑鼠。</p>
<p>但是對大多數的 Minecraft AI 專案而言，AI 觀察與操作都與人類大相逕庭。以 <a href="https://github.com/cabaletta/baritone" target="_blank" rel="noopener noreferrer">Baritone</a> （知名 Minecraft 自動外掛）為例，程式是直接讀取地圖上的方塊資料來規劃路徑，操作則是直接丟封包給伺服器，所以可以作到諸如隔著牆壁打開箱子之類的事情。</p>
<p>另外一個機器學習專案 <a href="https://github.com/MineDojo/Voyager" target="_blank" rel="noopener noreferrer">Voyager</a>則是包了一層的 Minecraft Client，真正操作與觀察的程式是一個叫做 <a href="https://github.com/PrismarineJS/mineflayer" target="_blank" rel="noopener noreferrer">Mineflayer</a> 的 Javascript 函式庫，與 Baritone 相同，直接讀取地圖資訊並呼叫函式來丟封包給伺服器完成操作。不同的是 Voyager 透過機器學習的 GPT-4 模型負責撰寫 Javascript 程式碼來控制玩家。</p>
<p>據我所知唯一使用視覺化資料的是一個名為 <a href="https://minerl.io/" target="_blank" rel="noopener noreferrer">MineRL</a> 的專案，它其實是一個 AI 競賽，目標就是用 AI 玩 Minecraft 挖到鑽石，但是 AI 只能跟玩家一樣觀察到一張 3D 渲染的第一人稱畫面，即便如此，它的操作依然不是沈浸式的<sup><a href="#user-content-fn-minerl-api-ce8ad3" id="user-content-fnref-minerl-api-ce8ad3" data-footnote-ref="true" aria-describedby="footnote-label">2</a></sup>：</p>
<p><img decoding="async" loading="lazy" src="/assets/images/03_minerl-action-cd55e139cb6f050ff6876af4c65b6d98.webp" width="719" height="357" class="img_RpFt"></p>
<p>它直接提供一個函式，當玩家附近有工作台並且身上有足夠的原 料，就直接完成合成，以人類可以理解的體驗就像是：</p>
<blockquote>
<p>你桌上放著一排按鈕，只要附近有工作台，按下對應的按鈕自動完成合成，過程中於需操作遊戲中的那個操作界面用滑鼠拖拉材料。</p>
</blockquote>
<p>因為 MineRL 設計上就是為了挖到鑽石，因此只需要提供部份必要的界面 (Interface) 供玩家操作即可。</p>
<p>「完全視覺化」意味著在這個專案中，視覺資料是 AI 唯一能夠獲得環境資訊的方式，FPV 控制器是 AI 唯一能和環境互動的手段，因此，沒有血量或體力值的變數、沒有額外的裝備欄變數、沒有任何基於滑鼠操作的彈出視窗、沒有快捷的 function call。</p>
<p>「完全視覺化」意味著必須重新設計一套完全基於 FPV 控制器的遊戲體驗。</p>
<h2 class="anchor anchorWithStickyNavbar_mpuI" id="二維條碼人造語言">二維條碼人造語言<a href="#二維條碼人造語言" class="hash-link" aria-label="Direct link to 二維條碼人造語言" title="Direct link to 二維條碼人造語言">​</a></h2>
<blockquote>
<p>關於我想用 ECS 實作 Minecraft 以分散式架構運行並在其中用增強式學習訓練完全視覺化之遞迴布林類神經網路以產出<strong>二維條碼人造語言</strong>那檔事</p>
</blockquote>
<p>其實我還期望從這個專案中獲得其他產物，不過「二維條碼人造語言」算是這個專案的主線之一。</p>
<p>如果你看過或是知道異星入境 (Arrival) 這部電影，要理解這個概念就會顯得很容易，沒有沒有也沒關係。</p>
<details class="details_s8O8 alert alert--info details_D2hA" data-collapsed="true"><summary>可能涉及「異星入境」的劇透，請斟酌點閱</summary><div><div class="collapsibleContent__aTr"><div><div>劇中的外星人不具備基於聲音的「語言」，</div><div>它們透過操控懸浮的沙粒構成文字來傳達意思：</div><img src="data:image/webp;base64,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" alt="https://brand-new-life.org/b-n-l/learning-from-time/"></div></div></div></details>
<p>我希望訓練 AI 在遊戲中表現出「部落」的特性，也就是複數個獨立的 AI 能夠溝通並且協調作業，在這個基礎上透過解析它們的溝通方式來實現「人類對某種數位智慧進行溝通」這件事。</p>
<p>一般玩家在 Minecraft 內使用文字頻道溝通，但是這有違前述的「完全視覺化」原則，因此我需要另外一種能夠讓玩家在遊戲內溝通的方式。在遊戲內重建聲學模型又過於複雜。</p>
<p>「基於<strong>視覺化</strong>的語言」這樣的概念便自然而然的被到這個專案之中，現實中其實也有這種東西：手語，而我所想像在 Minecraft 中的視覺化語言會像這個樣子：</p>
<p><img decoding="async" loading="lazy" src="/assets/images/04_barcode_language-33fbd182e107dc4451880a0192a0180f.svg" width="541" height="556" class="img_RpFt"></p>
<p>後來想想，基於二進制的智能體，溝通用的語言是二維條碼好像也很合理？</p>
<section data-footnotes="true" class="footnotes"><h2 class="anchor anchorWithStickyNavbar_mpuI sr-only" id="footnote-label">Footnotes<a href="#footnote-label" class="hash-link" aria-label="Direct link to Footnotes" title="Direct link to Footnotes">​</a></h2>
<ol>
<li id="user-content-fn-bnn-ce8ad3">
<p>Boolean Neural Network. (R. Kohut, B. Steinbach). Retrieved 2023-10-08, from <a href="https://www.semanticscholar.org/paper/Boolean-Neural-Networks-Kohut-Steinbach/1c472945ab2970a709efe97f81d9a5e7bf37baae" target="_blank" rel="noopener noreferrer">https://www.semanticscholar.org/paper/Boolean-Neural-Networks-Kohut-Steinbach/1c472945ab2970a709efe97f81d9a5e7bf37baae</a> <a href="#user-content-fnref-bnn-ce8ad3" data-footnote-backref="" aria-label="Back to reference 1" class="data-footnote-backref">↩</a></p>
</li>
<li id="user-content-fn-minerl-api-ce8ad3">
<p>MineRL 0.3.0 documentation. (William H. Guss, Brandon Houghton). Retrieved 2023-10-08, from <a href="https://minerl.io/docs/environments/index.html#id20" target="_blank" rel="noopener noreferrer">https://minerl.io/docs/environments/index.html#id20</a> <a href="#user-content-fnref-minerl-api-ce8ad3" data-footnote-backref="" aria-label="Back to reference 2" class="data-footnote-backref">↩</a></p>
</li>
</ol>
</section></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_Wp5O padding--none margin-left--sm"><li class="tag_UXKs"><a class="tag_lXMw tagRegular_c460" href="/blog/tags/the-key-of-huanche">The Key of Huanche</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="https://schema.org/BlogPosting"><meta itemprop="description" content="前情提要"><header><h2 class="title_BVkY" itemprop="headline"><a itemprop="url" href="/blog/2023-09-24_a-journey-about-learning-ecs">ECS 學習與 aimAndShoot 重構之旅</a></h2><div class="container_sDB1 margin-vert--md"><time datetime="2023-09-24T00:00:00.000Z" itemprop="datePublished">September 24, 2023</time> · <!-- -->13 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_SrKl"><div class="avatar margin-bottom--sm"><a href="https://github.com/FlySkyPie" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars.githubusercontent.com/u/9475660" alt="Wei Ji" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/FlySkyPie" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Wei Ji</span></a></div><small class="avatar__subtitle" itemprop="description">閃亮症候群工程屍</small></div></div></div></div></header><div class="markdown" itemprop="articleBody">
<p><img decoding="async" loading="lazy" src="/assets/images/00_hero-e6a285351e1adeec8573e4484429069c.webp" width="1440" height="762" class="img_RpFt"></p>
<h2 class="anchor anchorWithStickyNavbar_mpuI" id="前情提要">前情提要<a href="#前情提要" class="hash-link" aria-label="Direct link to 前情提要" title="Direct link to 前情提要">​</a></h2>
<p>隨著 Polis 專案的串流功能完成，開發開始往下一個階段發展，PoC 還剩下兩個功能需要實作：</p>
<ul>
<li>基本遊戲系統</li>
<li>P2P 連線</li>
</ul>
<p>因為 P2P 連線還需要解決遊戲狀態同步的問題，因此它在某種程度上仰賴遊戲系統，所以遊戲系統的實作就是我下一個階段要處理的事情。而遊戲系統預計要使用 ECS (Entity Component System) 實作則是很早就決定的事。</p>
<h3 class="anchor anchorWithStickyNavbar_mpuI" id="ecs-entity-component-system">ECS (Entity Component System)<a href="#ecs-entity-component-system" class="hash-link" aria-label="Direct link to ECS (Entity Component System)" title="Direct link to ECS (Entity Component System)">​</a></h3>
<p>關於 ECS 的具體細節本文就不再贅述，簡言之就是使用 ECS 架構的遊戲在做職責分離的時候會跟物件導向 (OOP) 中抽象化的思考方式不相同，這對我而言是一個挑戰，因為我沒有真正用 ECS 架構去寫遊戲過。</p>
<p>最早會接觸 ECS 這個新鮮玩意兒是因為工作的關係接觸了 <a href="https://github.com/bberak/react-game-engine" target="_blank" rel="noopener noreferrer">React Game Engine</a> 但是它只是 ECS 的弱實現 (loose implementation)，因此與實際 ECS 的思考方式之間還是存在落差，加上同事其實跟我提過我的寫法很大程度還是一般的 React 程式，並沒有發揮 ECS 的特性。</p>
<p>另外一個困擾我的點是，部分 Javascript/Typescript 實作的 ECS 函式庫著重於 ECS 中「資料緊湊」的特性，它們使用 TypedArray 定義的基本型態來儲存資料，這使得它們的原始設計與 Three.js 或 Rapier 這種有自己定義 class 的函式庫之間不好協調。</p>
<p>因此我認為在正式引入 ECS 這個技術 棧 (Tech Stack) 到 Polis 以前應該先寫一個短期專案對選定函式庫的可行性做驗證，以及累積足夠的「ECS 思維」。</p>
<h3 class="anchor anchorWithStickyNavbar_mpuI" id="aimandshoot">aimAndShoot<a href="#aimandshoot" class="hash-link" aria-label="Direct link to aimAndShoot" title="Direct link to aimAndShoot">​</a></h3>
<p><a href="https://github.com/victorqribeiro/aimAndShoot" target="_blank" rel="noopener noreferrer">aimAndShoot</a> 便是我的實驗對象。在「<a href="/blog/2023-01-04_origin-of-gear-redolence/">底火的芬芳 - 專案起源</a>」一文中有提到過這個 repository，它是一個有點像 <code>diep.io</code> 的簡單小遊戲，作為重構改寫的對象是再適合不過了。</p>
<h3 class="anchor anchorWithStickyNavbar_mpuI" id="miniplex">Miniplex<a href="#miniplex" class="hash-link" aria-label="Direct link to Miniplex" title="Direct link to Miniplex">​</a></h3>
<p><img decoding="async" loading="lazy" src="/assets/images/01_ecs-libs-ff9c1ec0cb14d9a23114b45e93215095.webp" width="1333" height="456" class="img_RpFt"></p>
<p>Javascript/Typescript 中有不少 <a href="https://npmtrends.com/@javelin/ecs-vs-ape-ecs-vs-bitecs-vs-ecs-lib-vs-ecsy-vs-miniplex-vs-yagl-ecs" target="_blank" rel="noopener noreferrer">ECS 套件</a>，雖然跟一般的熱門套件相較之下都算是冷門套件。</p>
<p>正如我提過得，它們之中的大部分著重於資料緊湊的設計，或是有著不支援/不友善 Typescript 的問題，另外一點則是一些套件更預設了一套框架，開發者必須在這個架構下開發。</p>
<p>相較之下 <a href="https://github.com/hmans/miniplex" target="_blank" rel="noopener noreferrer">Miniplex</a> 更深刻的體現了「一次做好一件事」的哲學，讓我們來看看它的介紹：</p>
<blockquote>
<p>A 👩‍💻 developer-friendly entity management system for 🕹 games and similarly demanding applications, based on 🛠 ECS architecture.</p>
</blockquote>
<p>是的，它只把自己定位在 「Entity Management」的部份，既不管資料緊不僅湊，也不管開發者想怎麼實作 System，即便看著範例程式碼，我也不會浮現「這玩意兒到底要怎麼跟 Three.js 或 Rapier 整合？」的問題，我只需要煩惱如何把問題使用 ECS 的架構去實現就好。</p>
<h2 class="anchor anchorWithStickyNavbar_mpuI" id="重構">重構<a href="#重構" class="hash-link" aria-label="Direct link to 重構" title="Direct link to 重構">​</a></h2>
<p>很快就完成了從 Javascript 轉換成 Typescript 的重構 (2023-09-13~2023-09-15)，這個部份應該算是整個重構中最簡單的，畢竟遷移 Legacy Code 我也不是第一次幹了，有一些工具可以協助完成這種事：</p>
<ul>
<li>AMD to es6<!-- -->
<ul>
<li><a href="https://github.com/jonbretman/amd-to-as6" target="_blank" rel="noopener noreferrer">https://github.com/jonbretman/amd-to-as6</a></li>
</ul>
</li>
<li>Prototype to Class<!-- -->
<ul>
<li><a href="https://github.com/lebab/lebab" target="_blank" rel="noopener noreferrer">https://github.com/lebab/lebab</a></li>
</ul>
</li>
<li>Javascript to Typescript<!-- -->
<ul>
<li><a href="https://github.com/gregjacobs/js-to-ts-converter" target="_blank" rel="noopener noreferrer">https://github.com/gregjacobs/js-to-ts-converter</a></li>
</ul>
</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_mpuI" id="web-component-custom-element-初體驗">Web Component (Custom Element) 初體驗<a href="#web-component-custom-element-初體驗" class="hash-link" aria-label="Direct link to Web Component (Custom Element) 初體驗" title="Direct link to Web Component (Custom Element) 初體驗">​</a></h3>
<p>微前端 (Micro frontends) 其實也不是什麼新鮮的玩意了，不過一直沒有機會或動機去使用它。第一次知道這個東西是為了解決客戶的（相對）大型專案而查資料查到的，只是客戶方面的技術相對落後（沒有 CI/CD、整合仰賴客戶的工程師手動複製程式碼、預計使用 iframe 作為大型專案的 solution...），而公司作為代工方並沒有技術決策的權限，自己本身也沒有 side project 有面臨類似的問題。</p>
<p>作為一個網頁前端工程師，UI 之類的問題我一律想用 React 解決，在 Canvas 上刻 UI 根本浪費時間效果又差。但是這個 ECS 的練習我並不想直接讓它跟 React App 耦合，發現這似乎是使用 Web Component 這個 <a href="https://developer.mozilla.org/en-US/docs/Web/API/Web_components" target="_blank" rel="noopener noreferrer">Web API</a> 的好時機。</p>
<p>於是一開始 (2023-09-16) 我先根據我預想的排版用 React 實作，再把它包裝成 <a href="https://developer.mozilla.org/en-US/docs/Web/API/Web_components/Using_custom_elements" target="_blank" rel="noopener noreferrer">Custom Element</a>，透過一個 callback (EventListener) 當 Canvas 被掛上 DOM 之後回傳 <code>HTMLCanvasElement</code> ，再用遊戲的實例去接收它來繪製遊戲內容。</p>
<p>當我把遊戲邏輯實作的差不多之後 (2023-09-20)，發現應該反過來操作：</p>
<blockquote>
<p>把遊戲封裝成 Custom Element 給 React 使</p>
</blockquote>
<p>因為整個遊戲其實只仰賴一塊 Canvas 作為 I/O，只要能夠恰當的完成初始化跟釋放資源，就能被封裝到 React 的 Cycle life 內才對。</p>
<p>另一方面也是因為我已經在 React 內寫過諸如 Three.js 和 MapBox GL JS 的東西，對於這種「非 React 原生的套件如何整合進 React App 內」已經很直覺的知道怎麼做了：用 <code>ref</code> 取得實例並搭配 <code>useEffect</code> 來把事件掛上去跟釋放 callback。</p>
<h3 class="anchor anchorWithStickyNavbar_mpuI" id="ecs">ECS<a href="#ecs" class="hash-link" aria-label="Direct link to ECS" title="Direct link to ECS">​</a></h3>
<p>Miniplex 的 Typescript 友善程度算是比我預期的的還好，關於 Entity 的型別如何聲明，Github 上面有一則討論算是給出了蠻明確的方向<sup><a href="#user-content-fn-miniplex-entity-type-b6b5a5" id="user-content-fnref-miniplex-entity-type-b6b5a5" data-footnote-ref="true" aria-describedby="footnote-label">1</a></sup>：</p>
<div class="language-typescript codeBlockContainer_HtHN theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_XzDj"><pre tabindex="0" class="prism-code language-typescript codeBlock_Kgad thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_xOgw"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token class-name">IPosition</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  position</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Vector3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token class-name">IHealth</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  health</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> current</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> max</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token class-name">Entity</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Partial</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">IPosition </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> IHealth </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">...</span><span class="token operator" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup_PN__"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_lePV" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_mz7K"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_aySJ"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>我個人是使用類似但是有一點差異的方式：</p>
<div class="language-typescript codeBlockContainer_HtHN theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_XzDj"><pre tabindex="0" class="prism-code language-typescript codeBlock_Kgad thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_xOgw"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token class-name">AgentEntity</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  id</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  particle</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ParticleComponent</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  health</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> HealthComponent</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  projectileEmitter</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ProjectileEmitterComponent</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  warrior</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> WarriorMiscComponent</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  brain</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> DejavuComponent</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  statistics</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> WarriorStatisticsComponent</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token class-name">BulletEntity</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  particle</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ParticleComponent</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  attackEffect</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> AttackEffectComponent</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token class-name">Entity</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Partial</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  TimeEntity </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> EventEntity </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> AgentEntity </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> BulletEntity</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup_PN__"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_lePV" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_mz7K"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_aySJ"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>以 ECS 的思考模式，其實並不在乎 Entity 要多具體，而是以 Component 為操作單元，而 Component 在中 Miniplex 實質等於 Entity 的 properties，因此如果思考方式依然受到 OOP 影響，至少可以用這種方式輔助產生一種介於「依照物件設計邏輯的切割方式」與「依照 Component 邏輯的切割方之」之間的過渡狀態。</p>
<p>另外因為我是從一個既存專案做重構，因此我懶得重新用「The Component Way」的思考模式去重新設計資料結構，所以我把物件的屬性隨便包成 Component 丟進去。</p>
<h3 class="anchor anchorWithStickyNavbar_mpuI" id="joy-ui-初體驗">Joy UI 初體驗<a href="#joy-ui-初體驗" class="hash-link" aria-label="Direct link to Joy UI 初體驗" title="Direct link to Joy UI 初體驗">​</a></h3>
<p>工作上很常要寫一些 B2B 的後台 (Dashboard)，<a href="https://mui.com/material-ui/" target="_blank" rel="noopener noreferrer">Material UI</a> 算是我最常使用的 React 套件之一，可以快速搭建出有模有樣的網頁，作用跟 <a href="https://getbootstrap.com/docs/5.2/getting-started/introduction/" target="_blank" rel="noopener noreferrer">Bootstrap</a> 其實差不多。只是它內置了一套設計系統 (Design System)，對於沒有引入 Design System 的專案來說，反而要為了那些缺乏一致性的客製化 style 去覆蓋掉原本的設計而花費很多心力。並且對於個人使用的小專案來說又稍嫌笨重了一點。</p>
<p>直到前一陣子注意到這個套件出了一個衍生套件 <a href="https://mui.com/joy-ui/getting-started/" target="_blank" rel="noopener noreferrer">Joy UI</a>，它的所有組件與 Material UI 幾乎是一對一對應的，只是少了 <a href="https://en.wikipedia.org/wiki/Material_Design" target="_blank" rel="noopener noreferrer">Material Design</a> 的部份。看上去也還算順眼，於是便趁著這個機會來用用看。</p>
<p>於是在完成了遊戲本體之後，便用這個套件新增了一些 UI，包含：玩家列表、記分板。</p>
<h3 class="anchor anchorWithStickyNavbar_mpuI" id="小插曲">小插曲<a href="#小插曲" class="hash-link" aria-label="Direct link to 小插曲" title="Direct link to 小插曲">​</a></h3>
<p>因為要重構成 ECS 架構的關係，所有的實作我都必須逐行閱讀了解其意義之後才能將邏輯從 class 內抽出然後丟到特定的 System 去，也因此讓我有了意外收穫。</p>
<p>幾年前 (2020)，我曾經改寫了同一個專案，移除了玩家、讓 Bot 分成兩隊互毆，但是成效不佳，跑了 300 多代依然蠢蠢的。</p>
<p>重構的過程我發現了有這麼一段程式：</p>
<div class="language-typescript codeBlockContainer_HtHN theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_XzDj"><pre tabindex="0" class="prism-code language-typescript codeBlock_Kgad thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_xOgw"><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">selectParent</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">queries</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> IQueries</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> total </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> bot </span><span class="token keyword" style="color:#00009f">of</span><span class="token plain"> queries</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">botPlayer</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      total </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> bot</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">statistics</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fitness</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> prob </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Math</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">random</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> total</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> bot </span><span class="token keyword" style="color:#00009f">of</span><span class="token plain"> queries</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">botPlayer</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">prob </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> bot</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">statistics</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fitness</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> bot</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      prob </span><span class="token operator" style="color:#393A34">-=</span><span class="token plain"> bot</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">statistics</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fitness</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup_PN__"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_lePV" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_mz7K"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_aySJ"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>原作者想用加權抽籤的方式抽出 AI 進行繁殖，其中的 <code>fitness</code> 是分數的意思，也就是這裡的權重值。然而這個實作會造成一個 AI 只要有一回合表現不好拿了 0 分，它被刷掉機率會達到 100%。並且只要有一回合大家運氣不好都拿了 0 分，就會整代被刷掉，演算法會直接 Random 一組 0 經驗的類神經網路來繁殖。</p>
<p>因此在不考慮評分標準的數學模型到底合理不合理的前提下，AI 被重置的機率其實很高，這也解釋了為什麼我之前跑了 300 多代 Bot 依然蠢蠢的原因。</p>
<h3 class="anchor anchorWithStickyNavbar_mpuI" id="收官-yose-ヨセ">收官 (Yose, ヨセ)<a href="#收官-yose-ヨセ" class="hash-link" aria-label="Direct link to 收官 (Yose, ヨセ)" title="Direct link to 收官 (Yose, ヨセ)">​</a></h3>
<p>重構過程其實讓我對這個專案產生了不少額外的想像，比如說：利用 ECS 的特性，我其實可以把當前遊戲幀的所有資料 dump 出來，之後重開網頁再把資料倒回去理論上可以很輕易的實現「遊戲讀擋」的功能，畢竟關於遊戲的所有狀態都塞在一個由 Entity 填充的 Array 裡面；又或是寫一個視覺化的組件呈現 AI 當前類神經網路的激發狀態；甚至是製作另一個模式實現我曾經實現過得 Zero-player game，理論上只要置換 System 就能輕易實現。</p>
<p>然而我其實對這個專案的定位有立下一個明確的目標：</p>
<blockquote>
<p>以 ECS 實現原專案的所有或大部份機能，藉此累積使用 Miniplex 的經驗</p>
</blockquote>
<p>目的已經達成，該收官了，於是我藉著這個星期六 (2023-09-23) 進行最後打磨，讓它至少看起來有模有樣，然後把原本分散在兩個 repo 的 commit 用 subtree 和 rebase 整理到 fork 的 repo 去。</p>
<h2 class="anchor anchorWithStickyNavbar_mpuI" id="結論">結論<a href="#結論" class="hash-link" aria-label="Direct link to 結論" title="Direct link to 結論">​</a></h2>
<ul>
<li>Demo<!-- -->
<ul>
<li><a href="https://flyskypie.github.io/aimAndShoot/" target="_blank" rel="noopener noreferrer">https://flyskypie.github.io/aimAndShoot/</a></li>
</ul>
</li>
<li>Source Code<!-- -->
<ul>
<li><a href="https://github.com/FlySkyPie/aimAndShoot" target="_blank" rel="noopener noreferrer">https://github.com/FlySkyPie/aimAndShoot</a></li>
</ul>
</li>
</ul>
<section data-footnotes="true" class="footnotes"><h2 class="anchor anchorWithStickyNavbar_mpuI sr-only" id="footnote-label">Footnotes<a href="#footnote-label" class="hash-link" aria-label="Direct link to Footnotes" title="Direct link to Footnotes">​</a></h2>
<ol>
<li id="user-content-fn-miniplex-entity-type-b6b5a5">
<p>Does Entity need to know all possible components?. Retrieved 2023-09-24, from <a href="https://github.com/hmans/miniplex/discussions/295" target="_blank" rel="noopener noreferrer">https://github.com/hmans/miniplex/discussions/295</a> <a href="#user-content-fnref-miniplex-entity-type-b6b5a5" data-footnote-backref="" aria-label="Back to reference 1" class="data-footnote-backref">↩</a></p>
</li>
</ol>
</section></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_Wp5O padding--none margin-left--sm"><li class="tag_UXKs"><a class="tag_lXMw tagRegular_c460" href="/blog/tags/learning-note">learning note</a></li><li class="tag_UXKs"><a class="tag_lXMw tagRegular_c460" href="/blog/tags/ecs">ECS</a></li><li class="tag_UXKs"><a class="tag_lXMw tagRegular_c460" href="/blog/tags/miniplex">Miniplex</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="https://schema.org/BlogPosting"><meta itemprop="description" content="前情提要"><header><h2 class="title_BVkY" itemprop="headline"><a itemprop="url" href="/blog/2023-08-27_opensource-robocraft">開源的 Robocraft Clone 專案 - Own War</a></h2><div class="container_sDB1 margin-vert--md"><time datetime="2023-08-27T00:00:00.000Z" itemprop="datePublished">August 27, 2023</time> · <!-- -->5 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_SrKl"><div class="avatar margin-bottom--sm"><a href="https://github.com/FlySkyPie" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars.githubusercontent.com/u/9475660" alt="Wei Ji" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/FlySkyPie" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Wei Ji</span></a></div><small class="avatar__subtitle" itemprop="description">閃亮症候群工程屍</small></div></div></div></div></header><div class="markdown" itemprop="articleBody">
<p><img decoding="async" loading="lazy" src="/assets/images/00_hero-b8dbf0cecc9c79291c393ed977dff702.webp" width="1406" height="900" class="img_RpFt"></p>
<h2 class="anchor anchorWithStickyNavbar_mpuI" id="前情提要">前情提要<a href="#前情提要" class="hash-link" aria-label="Direct link to 前情提要" title="Direct link to 前情提要">​</a></h2>
<p><a href="https://store.steampowered.com/app/301520/Robocraft/" target="_blank" rel="noopener noreferrer">Robocraft</a> 是一款載具建造戰鬥遊戲，屬於 (<a href="https://en.wikipedia.org/wiki/List_of_vehicular_combat_games" target="_blank" rel="noopener noreferrer">Vehicular Combat</a>) 的衍生種類，玩家可以設計自己的載具然後投入遊戲中與其他玩家進行 PvP 競技，是能帶給我樂趣的遊戲之一。</p>
<p>在某次更新之後這個遊戲的開發商大幅度削減 (Nerf) 獎勵系統，讓遊戲資源的獲取變得十分困難，使得創作方面的遊玩體驗上受到限制，使我一度退坑。</p>
<p>2022 左右再次回鍋的時候，獎勵系統與遊戲資源的限制已經被消除，雖然遊戲機制已經和以前有所不同了，但至少可以肯定開發商在遊戲平衡性上的努力，不過玩家基數下降，造成自動批配系統中的野團高機率會碰到有組團的對手，遇到這種情況通常會被慘虐。後來我注意到這遊戲在較冷門的階級 (Tier) 中為了減少玩家在自動批配系統中的等待，會加入 BOT 來促成 5v5 的遊戲，於是我就很不解開發商為什麼不願意內建 PVE (Player Versus Environment) 模式。</p>
<p>「在 Robocraft 的遊玩體驗之上引入 PVE 模式」便是我尋找替代方案的動機之一。</p>
<h2 class="anchor anchorWithStickyNavbar_mpuI" id="替代方案的嘗試">替代方案的嘗試<a href="#替代方案的嘗試" class="hash-link" aria-label="Direct link to 替代方案的嘗試" title="Direct link to 替代方案的嘗試">​</a></h2>
<p>然而遺憾的是，幾次搜尋下來，都沒有找到這種類型的開源專案，在 <a href="https://alternativeto.net/software/robocraft/" target="_blank" rel="noopener noreferrer">AlternativeTo</a> 上沒有找到滿意的結果。評價似乎不錯的 Crossout 並不支援 Linux，而且在 Steam 上還鎖區了一陣子。在 Reddit 的<a href="https://www.reddit.com/r/Robocraft/comments/87hoff/" target="_blank" rel="noopener noreferrer">討論串</a>中提到了 Procelio ，在早期（這專案剛啟動沒多久）有試著下載下來玩玩看，不過 Linux 版跑起來十分卡頓，而且我記得是用 Unity3D 做的。</p>
<p>直到上週 (2023-08-20)，我終於找到了 <a href="https://github.com/Demindiro/OwnWar" target="_blank" rel="noopener noreferrer">OwnWar</a>，一眼就能看出它是衝著 Robocraft Clone 去的開源專案。</p>
<h2 class="anchor anchorWithStickyNavbar_mpuI" id="dpendency-chain">Dpendency Chain<a href="#dpendency-chain" class="hash-link" aria-label="Direct link to Dpendency Chain" title="Direct link to Dpendency Chain">​</a></h2>
<p>拿到開源專案的第一件事當然就是自己 Build 看看，然而事情並沒有這麼簡單，這個專案是用 Godot 引擎撰寫的，但是是有打過 Patch 的 Godot 引擎,因此我需要自己編譯 Godot 引擎，而 Patch 本身又仰賴另外一個物理運算的函式庫 Rapier3D。那個函式庫是用 Rust 寫的，而且必須使用特定版本的編譯器才能編譯。加上我明顯感受到原作者留下的文件有缺失，並沒有完整描述 Build 的所有步驟。</p>
<p>於是我翻閱了 Godot 的文件，試著搞懂這個專案如何跟外部函式庫做 Binding ，接著我發現了了這個<a href="https://github.com/Demindiro/OwnWar/blob/a2a500991b786aed95977051fe91ac06699ff25e/gdn/ownwar/Cargo.toml#L15" target="_blank" rel="noopener noreferrer">東西</a>：</p>
<div class="language-toml codeBlockContainer_HtHN theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_XzDj"><pre tabindex="0" class="prism-code language-toml codeBlock_Kgad thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_xOgw"><span class="token-line" style="color:#393A34"><span class="token plain">[dependencies]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gdnative = &quot;*&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">lazy_static = &quot;*&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">godot_rapier3d = { path = &quot;../../../../game-assets/godot/godot_rapier3d/rapier3d&quot; }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fxhash = &quot;*&quot;</span><br></span></code></pre><div class="buttonGroup_PN__"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_lePV" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_mz7K"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_aySJ"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>那個相對路徑指向一個超出專案根目錄的位置，換句話說複數個專案的仰賴關係是隨意的擺在原作者的電腦內，無法根據留下的文件直接完成開發環境的準備，「原作者並沒有花太多心思考慮到接手的人，而是匆匆上傳專案」的假設基本上得到了驗證。</p>
<p>於是我花了一點時間從配置文件內的紀錄的外部仰賴路徑，推敲出數個庫之間的仰賴關係：</p>
<p><img decoding="async" loading="lazy" src="/assets/images/01_dependency-chain-dfc9647d13a61212cd2ee5eeb2c2c834.webp" width="2071" height="2195" class="img_RpFt"></p>
<h2 class="anchor anchorWithStickyNavbar_mpuI" id="成功編譯只是修改專案程式碼的第一步">成功編譯只是修改專案程式碼的第一步<a href="#成功編譯只是修改專案程式碼的第一步" class="hash-link" aria-label="Direct link to 成功編譯只是修改專案程式碼的第一步" title="Direct link to 成功編譯只是修改專案程式碼的第一步">​</a></h2>
<p>於是我 <a href="https://github.com/FlySkyPie/OwnWar" target="_blank" rel="noopener noreferrer">Fork</a> 了這個專案並把編譯仰賴的 Godot 引擎和外部函式庫等等瑣碎的操作通通丟到 Docker 裡面。最後終於把這個專案編譯出來了。</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_Wp5O padding--none margin-left--sm"><li class="tag_UXKs"><a class="tag_lXMw tagRegular_c460" href="/blog/tags/learning-note">learning note</a></li><li class="tag_UXKs"><a class="tag_lXMw tagRegular_c460" href="/blog/tags/godot">Godot</a></li><li class="tag_UXKs"><a class="tag_lXMw tagRegular_c460" href="/blog/tags/robocraft">Robocraft</a></li><li class="tag_UXKs"><a class="tag_lXMw tagRegular_c460" href="/blog/tags/voxel">voxel</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="https://schema.org/BlogPosting"><meta itemprop="description" content="行程間通訊 (IPC, Inter Process Communication) 是兩個行程（或以上）或執行緒間傳送資料或訊號的一些技術或方法。 如果有在 Node.js 玩過 childprocess 模組的 spawn 或是使用過 Web API 的 Worker 的話，應該對如何在 Javascript 中使用複數行程 (process) 並不陌生。"><header><h2 class="title_BVkY" itemprop="headline"><a itemprop="url" href="/blog/2023-08-08_electron-learning-note">Electron 學習筆記 - IPC</a></h2><div class="container_sDB1 margin-vert--md"><time datetime="2023-08-08T00:00:00.000Z" itemprop="datePublished">August 8, 2023</time> · <!-- -->2 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_SrKl"><div class="avatar margin-bottom--sm"><a href="https://github.com/FlySkyPie" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars.githubusercontent.com/u/9475660" alt="Wei Ji" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/FlySkyPie" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Wei Ji</span></a></div><small class="avatar__subtitle" itemprop="description">閃亮症候群工程屍</small></div></div></div></div></header><div class="markdown" itemprop="articleBody">
<p>行程間通訊 (IPC, Inter Process Communication) 是兩個行程（或以上）或執行緒間傳送資料或訊號的一些技術或方法。 如果有在 Node.js 玩過 <code>child_process</code> 模組的 <a href="https://nodejs.org/api/child_process.html#child_processspawncommand-args-options" target="_blank" rel="noopener noreferrer">spawn</a> 或是使用過 Web API 的 <a href="https://developer.mozilla.org/en-US/docs/Web/API/Worker" target="_blank" rel="noopener noreferrer">Worker</a> 的話，應該對如何在 Javascript 中使用複數行程 (process) 並不陌生。</p>
<h2 class="anchor anchorWithStickyNavbar_mpuI" id="區塊之間的通訊方式一覽">區塊之間的通訊方式一覽<a href="#區塊之間的通訊方式一覽" class="hash-link" aria-label="Direct link to 區塊之間的通訊方式一覽" title="Direct link to 區塊之間的通訊方式一覽">​</a></h2>
<p>在<a href="/blog/2023-04-01_electron_learning_note_intro">前一篇文章</a>提到，在 Electron 中 Render 和 Main 彼此之間是獨立的，必須透過 Preload 和 API 來實現兩者之間的溝通。參考了官方的範  例程式碼以及一篇文章<sup><a href="#user-content-fn-electron-ipc-bef557" id="user-content-fnref-electron-ipc-bef557" data-footnote-ref="true" aria-describedby="footnote-label">1</a></sup>之後，整理成一個圖表：</p>
<p><img decoding="async" loading="lazy" src="/assets/images/01_electron-ipc-api-2614c898ac2d7076cfc25d7ca88f52c4.webp" width="1377" height="1354" class="img_RpFt"></p>
<h2 class="anchor anchorWithStickyNavbar_mpuI" id="後記">後記<a href="#後記" class="hash-link" aria-label="Direct link to 後記" title="Direct link to 後記">​</a></h2>
<p>這篇文章原本在 2023-04-05 就已經寫好草稿了，沒想到完全忘記這篇還沒歸檔，然後圖表的 SVG 也已經刪掉了。</p>
<hr>
<p><a href="http://creativecommons.org/licenses/by-sa/4.0/" target="_blank" rel="noopener noreferrer"><img decoding="async" loading="lazy" src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png" alt="創用 CC 授權條款" class="img_RpFt"></a><br>
<!-- -->Wei Ji 以<a href="http://creativecommons.org/licenses/by-sa/4.0/" target="_blank" rel="noopener noreferrer">創用CC 姓名標示-相同方式分享 4.0 國際 授權條款</a>釋出。</p>
<section data-footnotes="true" class="footnotes"><h2 class="anchor anchorWithStickyNavbar_mpuI sr-only" id="footnote-label">Footnotes<a href="#footnote-label" class="hash-link" aria-label="Direct link to Footnotes" title="Direct link to Footnotes">​</a></h2>
<ol>
<li id="user-content-fn-electron-ipc-bef557">
<p>[ Day 9 ] - 動物聊天室(二) - IPC 與訊息交換 - iT 邦幫忙::一起幫忙解決難題，拯救 IT 人的一天. Retrieved 2023-08-08, from <a href="https://ithelp.ithome.com.tw/articles/10235110" target="_blank" rel="noopener noreferrer">https://ithelp.ithome.com.tw/articles/10235110</a> <a href="#user-content-fnref-electron-ipc-bef557" data-footnote-backref="" aria-label="Back to reference 1" class="data-footnote-backref">↩</a></p>
</li>
</ol>
</section></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_Wp5O padding--none margin-left--sm"><li class="tag_UXKs"><a class="tag_lXMw tagRegular_c460" href="/blog/tags/learning-note">learning note</a></li><li class="tag_UXKs"><a class="tag_lXMw tagRegular_c460" href="/blog/tags/javascript">javascript</a></li><li class="tag_UXKs"><a class="tag_lXMw tagRegular_c460" href="/blog/tags/electron">Electron</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="https://schema.org/BlogPosting"><meta itemprop="description" content="本篇學習筆記以 Javascript 在應用上的實作為切入點，關於 WebRTC 背後的技術並不是本文的重點。"><header><h2 class="title_BVkY" itemprop="headline"><a itemprop="url" href="/blog/2023-08-07_webrtc-learning-note">WebRTC 學習筆記</a></h2><div class="container_sDB1 margin-vert--md"><time datetime="2023-08-07T00:00:00.000Z" itemprop="datePublished">August 7, 2023</time> · <!-- -->3 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_SrKl"><div class="avatar margin-bottom--sm"><a href="https://github.com/FlySkyPie" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars.githubusercontent.com/u/9475660" alt="Wei Ji" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/FlySkyPie" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Wei Ji</span></a></div><small class="avatar__subtitle" itemprop="description">閃亮症候群工程屍</small></div></div></div></div></header><div class="markdown" itemprop="articleBody">
<div class="theme-admonition theme-admonition-note admonition_a71W alert alert--secondary"><div class="admonitionHeading_ZphC"><span class="admonitionIcon_vqjX"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_fKWC"><p>本篇學習筆記以 Javascript 在應用上的實作為切入點，關於 WebRTC 背後的技術並不是本文的重點。</p></div></div>
<p>看了幾篇教學仍然對 WebRTC Web API 的使用不是很理解，因為這些文章不是都著墨在 WebRTC 協定本身然後程式碼的實作就簡略帶過；就是跟使用 WebSocket 處理 SDP (Session Description Protocol) 的部份一起講，造成程式碼充滿了各種事件 callback，讓程式碼變得比較不好理解。</p>
<p>後來看到了一個<a href="https://github.com/Tinywan/WebRTC-tutorial/tree/master/docs/demo-02" target="_blank" rel="noopener noreferrer">範例程式</a>，單純針對 <code>RTCPeerConnection</code> 如何建立連線，從而省略實務上會透過其他機制完成 SDP，讓程式碼變得稍微好理解一點。</p>
<p>經過重構、Reivew 之後終於看懂使用 Javascript 建立 WebRTC 連線的流程，我把它整理成一張圖：</p>
<p><img decoding="async" loading="lazy" src="/assets/images/01_create-webrtc-b478fce1aac1c446153b8f810dc9c964.webp" width="1024" height="1141" class="img_RpFt"></p>
<p>大致有三個重點：</p>
<ol>
<li>兩邊的 Connection 都分別要從自己跟對方獲得 SessionDescription。</li>
<li>成對的 ICE (Interactive Connectivity Establishment) 處理程式 (handler)。</li>
<li><code>addTrack()</code> 與 <code>.on(&quot;track&quot;)</code> 用來發送/接收串流。</li>
</ol>
<hr>
<p>另外我練習<a href="https://github.com/FlySkyPie/canvas-webrtc-sample" target="_blank" rel="noopener noreferrer">使用 WebRTC 的程式</a>試著用不同的界面分離職責：</p>
<p><img decoding="async" loading="lazy" src="/assets/images/02_architecture-5e396c8f943429a3e6cc2bea1d560c1b.webp" width="886" height="958" class="img_RpFt"></p>
<ul>
<li><code>ITransmittable</code>: 發送端應用領域對傳輸領域的界面，專住於「對外串流」的職責。</li>
<li><code>IReceivable</code>: 接收端應用領域對傳輸領域的界面，，專注於「接收串流」的職責。</li>
<li><code>IRTCOfferable</code>: 發送端對連線建立領域的界面，專注於「發送方的 WebRTC 構成要件」的職責上。</li>
<li><code>IRTCAnswerable</code>: 接收端對連線建立領域的界面，專注於「接收方的 WebRTC 構成要件」的職責上。</li>
</ul>
<hr>
<p><a href="http://creativecommons.org/licenses/by-sa/4.0/" target="_blank" rel="noopener noreferrer"><img decoding="async" loading="lazy" src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png" alt="創用 CC 授權條款" class="img_RpFt"></a><br>
<!-- -->Wei Ji 以<a href="http://creativecommons.org/licenses/by-sa/4.0/" target="_blank" rel="noopener noreferrer">創用CC 姓名標示-相同方式分享 4.0 國際 授權條款</a>釋出。</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_Wp5O padding--none margin-left--sm"><li class="tag_UXKs"><a class="tag_lXMw tagRegular_c460" href="/blog/tags/learning-note">learning note</a></li><li class="tag_UXKs"><a class="tag_lXMw tagRegular_c460" href="/blog/tags/javascript">javascript</a></li><li class="tag_UXKs"><a class="tag_lXMw tagRegular_c460" href="/blog/tags/typescript">typescript</a></li><li class="tag_UXKs"><a class="tag_lXMw tagRegular_c460" href="/blog/tags/web-rtc">WebRTC</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="https://schema.org/BlogPosting"><meta itemprop="description" content="稍微把 Polis 挖坑至今 (2023-08-05) 累積的嘗試做個紀錄。"><header><h2 class="title_BVkY" itemprop="headline"><a itemprop="url" href="/blog/2023-08-05_polis-progress">Polis 專案研究進度</a></h2><div class="container_sDB1 margin-vert--md"><time datetime="2023-08-05T00:00:00.000Z" itemprop="datePublished">August 5, 2023</time> · <!-- -->12 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_SrKl"><div class="avatar margin-bottom--sm"><a href="https://github.com/FlySkyPie" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars.githubusercontent.com/u/9475660" alt="Wei Ji" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/FlySkyPie" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Wei Ji</span></a></div><small class="avatar__subtitle" itemprop="description">閃亮症候群工程屍</small></div></div></div></div></header><div class="markdown" itemprop="articleBody">
<p>稍微把 Polis 挖坑至今 (2023-08-05) 累積的嘗試做個紀錄。</p>
<h2 class="anchor anchorWithStickyNavbar_mpuI" id="基本概念">基本概念<a href="#基本概念" class="hash-link" aria-label="Direct link to 基本概念" title="Direct link to 基本概念">​</a></h2>
<p><img decoding="async" loading="lazy" src="/assets/images/01_polis-concept-8e1d6be862b17dfeebc30b8d8cdd83ac.webp" width="1080" height="993" class="img_RpFt"></p>
<p>整個開放世界會被拆分成不同的區域，每個區域由獨立的節點 (Polis Node) 負責運算，節點跟節點之間會構成 P2P 網路，形成一個可以橫向擴展的架構，而 Client 端則會在由 Polis Node 構成的 P2P 網路所運算的開放世界中進行漫遊 (Roaming)。其實這種分散式的架構在 ITUGV 的時宜就令我十分著迷，不過那就是另外一段故事了，在這裡稍微提及只是為了讓讀者理解筆者對分散式架構抱  有特別的偏好，並且這種構想早就存在於早期的其他專案之中。</p>
<h2 class="anchor anchorWithStickyNavbar_mpuI" id="poc-proof-of-concept">POC (Proof Of Concept)<a href="#poc-proof-of-concept" class="hash-link" aria-label="Direct link to POC (Proof Of Concept)" title="Direct link to POC (Proof Of Concept)">​</a></h2>
<p>雖然 Polis 作為 Hakoniwa 的子專案，目的一樣是為了建造一個程序化生成 Voxel 開放世界，但是 Polis 將會把重點放在兩個目標上：</p>
<ul>
<li>建立 P2P 網路</li>
<li>能夠透過 Client 程式連線</li>
</ul>
<p>因此在 Polis 的第一個原型中，達到這些條件就算成功完成了概念驗證：</p>
<p><img decoding="async" loading="lazy" src="/assets/images/02_POC-c0c7aaf1dd8fb44ae4dcba0c3c5f130b.webp" width="1568" height="1195" class="img_RpFt"></p>
<h2 class="anchor anchorWithStickyNavbar_mpuI" id="2023-05-13--2023-05-26">2023-05-13 ~ 2023-05-26<a href="#2023-05-13--2023-05-26" class="hash-link" aria-label="Direct link to 2023-05-13 ~ 2023-05-26" title="Direct link to 2023-05-13 ~ 2023-05-26">​</a></h2>
<p>在這個階段我想用 Deno 作為實作 Polis Node 的手段，有幾個原因：</p>
<ol>
<li>Typescript 目前是我最熟練的語言。</li>
<li>WebGPU 已經納入 Web API 中，而部份版本的 Deno 已經實作，因此我能使用 Typescript 解決 server side render 的需求，這麼部份是 Node.js 無法達成的。</li>
<li>Deno 內建跨平台編譯 (Cross Compiling)，因此寫一次程式我就能把節點佈署到除了 Linux 以外的 Windows 或是 macOS 上。</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_mpuI" id="網路連接技術">網路連接技術<a href="#網路連接技術" class="hash-link" aria-label="Direct link to 網路連接技術" title="Direct link to 網路連接技術">​</a></h3>
<p>在挖了坑並且對技術棧 (Technology Stack) 有了粗略的方向之後，首先我想先處理 Polis 中最關鍵的問題：</p>
<blockquote>
<p>如何建立 Polis 網路 （P2P 網路）？</p>
</blockquote>
<p>在 2020-03-22 的時候我就有使用 ZeroMQ 進行過傳輸相關的<a href="https://github.com/FlySkyPie/the-key-of-huanche-recipe/tree/main/src/core/gym/Test_of_Image_Transfer_with_Different_Decode" target="_blank" rel="noopener noreferrer">實驗</a>，也是我在 The Key of Huanche 中一直考慮投入使用的函式庫。直到我因為 Polis 的分散式架構回過頭去翻閱它的官方文件的時候，才發現了一件事：</p>
<blockquote>
<p>And this is the world we’re targeting with ZeroMQ. When we talk of “scale”, we don’t mean hundreds of computers, or even thousands. Think of clouds of tiny smart and perhaps self-replicating machines surrounding every person, filling every space, covering every wall, filling the cracks and eventually, becoming so much a part of us that we get them before birth and they follow us to death. <sup><a href="#user-content-fn-zeromq-8-ba688f" id="user-content-fnref-zeromq-8-ba688f" data-footnote-ref="true" aria-describedby="footnote-label">1</a></sup></p>
</blockquote>
<p>ZeroMQ 在官方文件 <a href="https://zguide.zeromq.org/docs/chapter8/" target="_blank" rel="noopener noreferrer">Chapter 8 - A Framework for Distributed Computing</a> 中描述了他們那野心勃勃的願景，老實說這非常打動我。</p>
<p>然而調查下來，發現 Deno 在這方面並沒有多少函式庫可以使用、專案的活躍度也都很低：</p>
<ul>
<li><a href="https://github.com/jjeffcaii/deno-zeromq" target="_blank" rel="noopener noreferrer">https://github.com/jjeffcaii/deno-zeromq</a></li>
<li><a href="https://github.com/rracariu/deno-jszmq" target="_blank" rel="noopener noreferrer">https://github.com/rracariu/deno-jszmq</a></li>
<li>似乎只有實作 WekSocket</li>
<li><a href="https://github.com/trs/zmq" target="_blank" rel="noopener noreferrer">https://github.com/trs/zmq</a>
<ul>
<li>deno-jszmq 的 fork</li>
</ul>
</li>
<li><a href="https://github.com/lenkan/deno-amqp" target="_blank" rel="noopener noreferrer">https://github.com/lenkan/deno-amqp</a></li>
<li>兼容 RabbitMQ</li>
<li>只支援 Server-Client 模式</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_mpuI" id="資料傳輸載體">資料傳輸載體<a href="#資料傳輸載體" class="hash-link" aria-label="Direct link to 資料傳輸載體" title="Direct link to 資料傳輸載體">​</a></h3>
<p>Protobuf (Protocol Buffers) 是另外一個我有意投入 The Key of Huanche 使用的 Technology Stack，第一次知道它的存在是工作上使用 Mapbox 的並因此接觸 <a href="https://github.com/mapbox/vector-tile-spec" target="_blank" rel="noopener noreferrer">Mapbox Vector Tile</a> 的時候發現它所使用的資料格式。簡言之就是一種預先定義資料結構後，把資料壓成密度比較高的格式進行傳輸，到達目的地之後再用預先定義的資料結構進行解碼，比起使用 JSON 傳輸可以省下很多頻寬。</p>
<p>然而在 Deno 的生態戲中依然有類似的問題，能選用的函式庫很少、而且專案活躍路很低：</p>
<ul>
<li><a href="https://github.com/soootaleb/ddapps" target="_blank" rel="noopener noreferrer">https://github.com/soootaleb/ddapps</a>
<ul>
<li>Deno distributed applications framework</li>
</ul>
</li>
<li><a href="https://deno.land/x/protobuf_ts@v1.2.2" target="_blank" rel="noopener noreferrer">https://deno.land/x/protobuf_ts@v1.2.2</a>
<ul>
<li><a href="https://github.com/dancrumb/protobuf.ts" target="_blank" rel="noopener noreferrer">https://github.com/dancrumb/protobuf.ts</a></li>
</ul>
</li>
<li><a href="https://deno.land/x/deno_google_protobuf@4.0.0-rc.2" target="_blank" rel="noopener noreferrer">https://deno.land/x/deno_google_protobuf@4.0.0-rc.2</a>
<ul>
<li><a href="https://github.com/marcushultman/deno-google-protobuf" target="_blank" rel="noopener noreferrer">https://github.com/marcushultman/deno-google-protobuf</a></li>
</ul>
</li>
<li><a href="https://pbkit.dev/" target="_blank" rel="noopener noreferrer">https://pbkit.dev/</a>
<ul>
<li><a href="https://deno.land/x/pbkit@v0.0.61" target="_blank" rel="noopener noreferrer">https://deno.land/x/pbkit@v0.0.61</a></li>
<li><a href="https://github.com/pbkit/pbkit" target="_blank" rel="noopener noreferrer">https://github.com/pbkit/pbkit</a></li>
</ul>
</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_mpuI" id="如何分辨序列化資料-protobuf-的型別">如何分辨序列化資料 Protobuf 的型別？<a href="#如何分辨序列化資料-protobuf-的型別" class="hash-link" aria-label="Direct link to 如何分辨序列化資料 Protobuf 的型別？" title="Direct link to 如何分辨序列化資料 Protobuf 的型別？">​</a></h4>
<p>Polis Node 之間的通訊基本上是一個事件系統，而事件的種類千奇百怪，需要的資料結構當然也是五花八門，但是它們之間會使用同一個序列化的通道，接收端街收到一組序列化資料後要怎麼區分 Protobuf 的類型並使用不同的結構來解碼呢？</p>
<p>沒有辦法直接區分，但是可以透過幾個方法解決這個問題<sup><a href="#user-content-fn-protobuf-type-detect-ba688f" id="user-content-fnref-protobuf-type-detect-ba688f" data-footnote-ref="true" aria-describedby="footnote-label">2</a></sup>：</p>
<ul>
<li>定義一個 Protobuf 封裝來夾帶型別資訊<!-- -->
<ul>
<li>用 oneof 封裝 (也被稱作 union)<!-- -->
<ul>
<li><a href="https://stackoverflow.com/a/40040658" target="_blank" rel="noopener noreferrer">https://stackoverflow.com/a/40040658</a></li>
<li><a href="https://protobuf.dev/programming-guides/proto2/#oneof" target="_blank" rel="noopener noreferrer">https://protobuf.dev/programming-guides/proto2/#oneof</a></li>
<li><a href="https://protobuf.dev/programming-guides/proto3/#oneof" target="_blank" rel="noopener noreferrer">https://protobuf.dev/programming-guides/proto3/#oneof</a></li>
</ul>
</li>
<li>將另外一組 proto 封裝成 any 屬性<!-- -->
<ul>
<li><a href="https://protobuf.dev/programming-guides/techniques/#self-description" target="_blank" rel="noopener noreferrer">https://protobuf.dev/programming-guides/techniques/#self-description</a></li>
</ul>
</li>
</ul>
</li>
<li>在 buffer 加入幾個 bytes 的前輟作為辨識符</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_mpuI" id="壓垮-deno-對我的專案而言的最後一根稻草">壓垮 Deno （對我的專案而言）的最後一根稻草<a href="#壓垮-deno-對我的專案而言的最後一根稻草" class="hash-link" aria-label="Direct link to 壓垮 Deno （對我的專案而言）的最後一根稻草" title="Direct link to 壓垮 Deno （對我的專案而言）的最後一根稻草">​</a></h3>
<p>我其實很難找到支援 WebGPU 或是活躍的 WebGL 的 Javascript 函式庫進行 &quot;denolize&quot;。</p>
<p>WebGPU 在那個當下只有 0.04% 的覆蓋率，就算打開先行版 Chrome 的 WebGPU flag 也是充滿破圖，因此鮮少有函式庫有支援 WebGPU。</p>
<p><img decoding="async" loading="lazy" src="/assets/images/03_webgpu-usage-a72772a075cdcaf6b42490f78498faf1.webp" width="797" height="262" class="img_RpFt"></p>
<p>活躍的 Javascript 3D 繪圖函式庫，諸如：Three.js, Babylon.js，即便當下是基於 WebGL 實作，在 WebGPU 逐漸普及下應該也會逐步支援 WebGPU 才對，但是它們多是基於 Canvas 的繪圖方式，而 Deno 環境下的 WebGPU 實作並不包含 Canvas 相關方法。</p>
<p>加上 WebGPU 的 API 在 1.8 被加入 Deno 之後<sup><a href="#user-content-fn-deno-1.8-ba688f" id="user-content-fnref-deno-1.8-ba688f" data-footnote-ref="true" aria-describedby="footnote-label">3</a></sup>，又在 1.32.0 中基於性能考量被移除了<sup><a href="#user-content-fn-deno-1.32.0-ba688f" id="user-content-fnref-deno-1.32.0-ba688f" data-footnote-ref="true" aria-describedby="footnote-label">4</a></sup>。</p>
<p>也就是「在 Deno 中使用 WebGPU」這件是的前景並不樂觀，我可能必須要面對「使用舊版的 Deno 和相對底層的 WebGPU 手刻整個應用」的問題。</p>
<p>Deno 的 Cross Compiling 的能力是真的很吸引我，但是在繪圖跟網路連線兩面不討好的情況下，加上 IDE 在寫 Deno 程式的時候開發體驗並不好，我決定放棄這條路。</p>
<h2 class="anchor anchorWithStickyNavbar_mpuI" id="2023-05-27--2023-06-11">2023-05-27 ~ 2023-06-11<a href="#2023-05-27--2023-06-11" class="hash-link" aria-label="Direct link to 2023-05-27 ~ 2023-06-11" title="Direct link to 2023-05-27 ~ 2023-06-11">​</a></h2>
<p>在 2022-10-06 的時候我就已經嘗試過把網頁上渲染的 Canvas 畫面壓成 Webp 並透過 WebSocket 傳送給伺服器播放了<sup><a href="#user-content-fn-simple-stream-ba688f" id="user-content-fnref-simple-stream-ba688f" data-footnote-ref="true" aria-describedby="footnote-label">5</a></sup>，但是當時只是寫了 POC 等級的程式，並不能很好的管理每次連線的 Session，因此良好的串流機制就成了我下一個研究目標。</p>
<h3 class="anchor anchorWithStickyNavbar_mpuI" id="串流方案">串流方案<a href="#串流方案" class="hash-link" aria-label="Direct link to 串流方案" title="Direct link to 串流方案">​</a></h3>
<p><img decoding="async" loading="lazy" alt="https://www.wowza.com/wp-content/uploads/latency-continuum-2021-with-protocols-700x300-1.png" src="/assets/images/04_stream-latency-2d1415ec6bf572221ff968e2888a9f31.webp" width="700" height="380" class="img_RpFt"></p>
<p>花了一點時間 (2023-05-27~2023-05-28) 查資料了解有哪些可能的方案能夠實現我的需求：</p>
<ul>
<li>Websocket<!-- -->
<ul>
<li>✅ Web API 十分普及</li>
<li>❌ 需額外處理影像的解碼與渲染，消費更多的運算與延遲</li>
</ul>
</li>
<li>WebRTC<!-- -->
<ul>
<li>✅ Web API 十分普及</li>
<li>✅ 原生設計支援低延遲</li>
<li>❌ 協定複雜</li>
<li>❌ P2P 架構，雖然可能可以透過在伺服器實作底層來欺騙 client 端，但是需付出額外開發成本</li>
</ul>
</li>
<li>WebTransport/QUIC<!-- -->
<ul>
<li>✅ 支援 UDP，可降低延遲</li>
<li>✅ 次世代 API</li>
<li>❌ Web API 尚未普及<!-- -->
<ul>
<li>瀏覽器支援覆蓋率低</li>
<li>Nodejs 僅實驗性支援 QUIC</li>
<li>Deno 尚不支援</li>
</ul>
</li>
</ul>
</li>
<li>HTML5 video tag<!-- -->
<ul>
<li>✅ Web API 十分普及</li>
<li>❌ 高延遲</li>
</ul>
</li>
<li>Video.js</li>
<li>MPEG-DASH<!-- -->
<ul>
<li>✅ 開放的標準</li>
<li>❌ 有點複雜</li>
</ul>
</li>
<li>FLV<!-- -->
<ul>
<li>✅ 歷史性因素，仍有許多資源</li>
<li>❌ 過時</li>
</ul>
</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_mpuI" id="node-media-server">Node-Media-Server<a href="#node-media-server" class="hash-link" aria-label="Direct link to Node-Media-Server" title="Direct link to Node-Media-Server">​</a></h3>
<p><img decoding="async" loading="lazy" src="/assets/images/05_Node-Media-Server-f6c9a6eaf1b0d27f12dc5399fe257ff0.webp" width="1223" height="762" class="img_RpFt"></p>
<p>之後 (2023-06-04) 發現了 <a href="https://github.com/illuspas/Node-Media-Server" target="_blank" rel="noopener noreferrer">Node-Media-Server</a> 這個專案，透過 RTMP (Real-Time Messaging Protocol) 向 Node-Media-Server 串流影像，接著能夠使用 <a href="https://github.com/illuspas/Node-Media-Server-Admin" target="_blank" rel="noopener noreferrer">Node-Media-Server-Admin</a> 打開串流，而且能夠流暢的關閉與重新開啟串流，Session 的管理便是我在 POC 階段所缺失的，並且它能夠使用以 Javascript 撰寫的 code base 對外進行串流，那我只要有辦法用 Javascript 產生 RTMP 流，就能整合成符合我需求的程式。</p>
<p>於是我便試著透過用 Typescript <a href="https://github.com/FlySkyPie/Node-Media-Server-ts" target="_blank" rel="noopener noreferrer">重構專案</a>的方式理解它是如何實現串流推流的。</p>
<h2 class="anchor anchorWithStickyNavbar_mpuI" id="2023-06-11--2023-06-25">2023-06-11 ~ 2023-06-25<a href="#2023-06-11--2023-06-25" class="hash-link" aria-label="Direct link to 2023-06-11 ~ 2023-06-25" title="Direct link to 2023-06-11 ~ 2023-06-25">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_mpuI" id="rtmp">RTMP<a href="#rtmp" class="hash-link" aria-label="Direct link to RTMP" title="Direct link to RTMP">​</a></h3>
<p><img decoding="async" loading="lazy" src="/assets/images/06_RTMP-learning-note-db26060598ed37f00e25f95e196510ad.webp" width="5411" height="4079" class="img_RpFt"></p>
<p>接著我發現單靠程式碼無法理解它解析 RTMP 封包的邏輯，於是我便打開 <a href="https://rtmp.veriskope.com/docs/spec" target="_blank" rel="noopener noreferrer">RTMP 的規範文件</a>並搭配一些教學文章試著理解它，不過大約只讀到 Header 的部份，我就意識到就算我能製造 RTMP 堆流，還是需要把影像做編碼，然而 Javascript 的生態系在做這件事情上有點貧弱，於是我把目光轉而投向 WebRTC。</p>
<p>至於 RTMP 的學習筆記我應該會發到另外一篇獨立的文章去，雖然因為我其實沒有把 Spec 完整看完，發個不完整的筆記感覺怪彆扭的。=w=&quot;</p>
<h2 class="anchor anchorWithStickyNavbar_mpuI" id="2023-06-25--2023-08-05">2023-06-25 ~ 2023-08-05<a href="#2023-06-25--2023-08-05" class="hash-link" aria-label="Direct link to 2023-06-25 ~ 2023-08-05" title="Direct link to 2023-06-25 ~ 2023-08-05">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_mpuI" id="webrtc">WebRTC<a href="#webrtc" class="hash-link" aria-label="Direct link to WebRTC" title="Direct link to WebRTC">​</a></h3>
<p><img decoding="async" loading="lazy" src="/assets/images/07_webrtc-demo-7de5ea33f86178327ce1788fadade79a.webp" width="1308" height="382" class="img_RpFt"></p>
<p>7 月份因為工作上的壓力比較大，加上充滿了親戚過世、Steam 夏季特賣、COSUP...等等事件，所以學習 WebRTC 的進度可以說是其極緩慢，不過終於在昨天 (2023-08-05) 理解如何使用這個 Web API 並把<a href="https://github.com/FlySkyPie/canvas-webrtc-sample" target="_blank" rel="noopener noreferrer">範例</a>做出來了。</p>
<p>同樣的，關於 WebRTC 的學習筆記我會放在另外一篇  獨立的文章。</p>
<hr>
<p><a href="http://creativecommons.org/licenses/by-sa/4.0/" target="_blank" rel="noopener noreferrer"><img decoding="async" loading="lazy" src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png" alt="創用 CC 授權條款" class="img_RpFt"></a><br>
<!-- -->Wei Ji 以<a href="http://creativecommons.org/licenses/by-sa/4.0/" target="_blank" rel="noopener noreferrer">創用CC 姓名標示-相同方式分享 4.0 國際 授權條款</a>釋出。</p>
<section data-footnotes="true" class="footnotes"><h2 class="anchor anchorWithStickyNavbar_mpuI sr-only" id="footnote-label">Footnotes<a href="#footnote-label" class="hash-link" aria-label="Direct link to Footnotes" title="Direct link to Footnotes">​</a></h2>
<ol>
<li id="user-content-fn-zeromq-8-ba688f">
<p>Chapter 8 - A Framework for Distributed Computing. Retrieved 2023-08-05, from <a href="https://zguide.zeromq.org/docs/chapter8" target="_blank" rel="noopener noreferrer">https://zguide.zeromq.org/docs/chapter8</a> <a href="#user-content-fnref-zeromq-8-ba688f" data-footnote-backref="" aria-label="Back to reference 1" class="data-footnote-backref">↩</a></p>
</li>
<li id="user-content-fn-protobuf-type-detect-ba688f">
<p>c# - Protocol buffers detect type from raw message - Stack Overflow. Retrieved 2023-08-06, from <a href="https://stackoverflow.com/a/9125119" target="_blank" rel="noopener noreferrer">https://stackoverflow.com/a/9125119</a> <a href="#user-content-fnref-protobuf-type-detect-ba688f" data-footnote-backref="" aria-label="Back to reference 2" class="data-footnote-backref">↩</a></p>
</li>
<li id="user-content-fn-deno-1.8-ba688f">
<p>Deno 1.8 Release Notes. Retrieved 2023-08-05, from <a href="https://deno.com/blog/v1.8" target="_blank" rel="noopener noreferrer">https://deno.com/blog/v1.8</a> <a href="#user-content-fnref-deno-1.8-ba688f" data-footnote-backref="" aria-label="Back to reference 3" class="data-footnote-backref">↩</a></p>
</li>
<li id="user-content-fn-deno-1.32.0-ba688f">
<p>Release v1.32.0 · denoland/deno. Retrieved 2023-08-05, from <a href="https://github.com/denoland/deno/releases/tag/v1.32.0" target="_blank" rel="noopener noreferrer">https://github.com/denoland/deno/releases/tag/v1.32.0</a> <a href="#user-content-fnref-deno-1.32.0-ba688f" data-footnote-backref="" aria-label="Back to reference 4" class="data-footnote-backref">↩</a></p>
</li>
<li id="user-content-fn-simple-stream-ba688f">
<p>Day 22 Streaming POC - iT 邦幫忙::一起幫忙解決難題，拯救 IT 人的一天. Retrieved 2023-08-05, from <a href="https://ithelp.ithome.com.tw/articles/10305097" target="_blank" rel="noopener noreferrer">https://ithelp.ithome.com.tw/articles/10305097</a> <a href="#user-content-fnref-simple-stream-ba688f" data-footnote-backref="" aria-label="Back to reference 5" class="data-footnote-backref">↩</a></p>
</li>
</ol>
</section></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_Wp5O padding--none margin-left--sm"><li class="tag_UXKs"><a class="tag_lXMw tagRegular_c460" href="/blog/tags/polis">Polis</a></li><li class="tag_UXKs"><a class="tag_lXMw tagRegular_c460" href="/blog/tags/hakoniwa">Hakoniwa</a></li><li class="tag_UXKs"><a class="tag_lXMw tagRegular_c460" href="/blog/tags/the-key-of-huanche">The Key of Huanche</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="https://schema.org/BlogPosting"><meta itemprop="description" content="- 一種去中心化叢集運算架構，用以建構運算 Hakoniwa 的網路。"><header><h2 class="title_BVkY" itemprop="headline"><a itemprop="url" href="/blog/2023-05-14_project-polis">Polis Project</a></h2><div class="container_sDB1 margin-vert--md"><time datetime="2023-05-14T00:00:00.000Z" itemprop="datePublished">May 14, 2023</time> · <!-- -->3 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_SrKl"><div class="avatar margin-bottom--sm"><a href="https://github.com/FlySkyPie" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars.githubusercontent.com/u/9475660" alt="Wei Ji" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/FlySkyPie" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Wei Ji</span></a></div><small class="avatar__subtitle" itemprop="description">閃亮症候群工程屍</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p><img decoding="async" loading="lazy" src="data:image/webp;base64,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" width="1080" height="233" class="img_RpFt"></p>
<ul>
<li>一種去中心化叢集運算架構，用以建構運算 Hakoniwa 的網路。</li>
<li>Polis 是「古希臘城邦」的意思。</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_mpuI" id="基本概念-concept">基本概念 Concept<a href="#基本概念-concept" class="hash-link" aria-label="Direct link to 基本概念 Concept" title="Direct link to 基本概念 Concept">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_mpuI" id="技術痛點">技術痛點<a href="#技術痛點" class="hash-link" aria-label="Direct link to 技術痛點" title="Direct link to 技術痛點">​</a></h3>
<p>具我所知 Minecraft 在軟體層面有兩個瓶頸：</p>
<ul>
<li>複雜的 OOP 結構</li>
<li>伺服器端使用單執行緒</li>
</ul>
<p>以前我試著寫 Minecraft <a href="https://youtu.be/vH0KOeijNeQ" target="_blank" rel="noopener noreferrer">插件</a>的時候，因為有使用到 NMS (net.minecraft.server) 的 API，因此大概知道 Minecraft 的程式碼大量使用了多層繼承 (Multilevel Inheritance)，然而這種 OOP 模式不只增加了開發者的負擔（本人認為多層繼承是一種反模式），更會造成在處理 Minecraft 這樣複雜的遊戲內容時，狀態的管理不容易控制而造成 bug 並且難以排除。</p>
<p>於是我打算使用 ECS (Entity Component System) 架構來解決，其概念就是單純化資料容器 (Entity 與 Component)，由 System 執行邏輯運算，透過分離資料和邏輯達到更清晰的程式碼，並且複數 System 有序執行的方式讓狀態管理單純化。然而這個架構有個問題，就是 System 有序執行的特性讓我不知道如何搭配多執行緒來提高軟體對硬體資源的利用率。</p>
<h3 class="anchor anchorWithStickyNavbar_mpuI" id="遊戲運算平行化">遊戲運算平行化<a href="#遊戲運算平行化" class="hash-link" aria-label="Direct link to 遊戲運算平行化" title="Direct link to 遊戲運算平行化">​</a></h3>
<p>其中 一個合理的解方是以地圖的 Chunk 為單位切割最小的運算區塊 (Game Block)，一個 Game Block 由一個執行緒處理運算，Game Block 之間（也就是執行緒之間）的通訊則由事件驅動。</p>
<p>舉例來說，有一支箭矢飛越運算區塊的邊界：</p>
<p><img decoding="async" loading="lazy" src="/assets/images/01_chunk-roaming-7938eb8ed8d93d87318b6ac271c7cfc7.webp" width="1004" height="681" class="img_RpFt"></p>
<p>來源 Game Block 會把箭矢的資訊包裝成一個事件，發送給目標 Game Block，並且從資料集中移除。目標 Game Block 則是根據事件創建一個箭矢實體並繼續運算。兩個 Game Block 使用獨立的執行緒，並且運算週期並不同步，因此不會凍結彼此。</p>
<h3 class="anchor anchorWithStickyNavbar_mpuI" id="何不乾脆-p2p">何不乾脆 P2P?<a href="#何不乾脆-p2p" class="hash-link" aria-label="Direct link to 何不乾脆 P2P?" title="Direct link to 何不乾脆 P2P?">​</a></h3>
<p>不知道為什麼，我直覺覺得比起寫成一個 APP 管理一堆 Game Block，不如乾脆全部做成微服務，讓它們自己構成一個叢集比較好。於是一個新的坑 (Polis) 就產生了。</p>
<hr>
<p><a href="http://creativecommons.org/licenses/by-sa/4.0/" target="_blank" rel="noopener noreferrer"><img decoding="async" loading="lazy" src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png" alt="創用 CC 授權條款" class="img_RpFt"></a><br>
<!-- -->Wei Ji 以<a href="http://creativecommons.org/licenses/by-sa/4.0/" target="_blank" rel="noopener noreferrer">創用CC 姓名標示-相同方式分享 4.0 國際 授權條款</a>釋出。</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_Wp5O padding--none margin-left--sm"><li class="tag_UXKs"><a class="tag_lXMw tagRegular_c460" href="/blog/tags/polis">Polis</a></li><li class="tag_UXKs"><a class="tag_lXMw tagRegular_c460" href="/blog/tags/hakoniwa">Hakoniwa</a></li><li class="tag_UXKs"><a class="tag_lXMw tagRegular_c460" href="/blog/tags/the-key-of-huanche">The Key of Huanche</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="https://schema.org/BlogPosting"><meta itemprop="description" content="這裡整理幾種 C++ 專案常見的處理仰賴函式庫的模式（或是工具）。"><header><h2 class="title_BVkY" itemprop="headline"><a itemprop="url" href="/blog/2023-04-11_dependencies-in-cpp-project">在 C++ 專案中處理仰賴套件的幾種方式</a></h2><div class="container_sDB1 margin-vert--md"><time datetime="2023-04-11T00:00:00.000Z" itemprop="datePublished">April 11, 2023</time> · <!-- -->2 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_SrKl"><div class="avatar margin-bottom--sm"><a href="https://github.com/FlySkyPie" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars.githubusercontent.com/u/9475660" alt="Wei Ji" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/FlySkyPie" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Wei Ji</span></a></div><small class="avatar__subtitle" itemprop="description">閃亮症候群工程屍</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>這裡整理幾種 C++ 專案常見的處理仰賴函式庫的模式（或是工具）。</p>
<h2 class="anchor anchorWithStickyNavbar_mpuI" id="copypaste-source">Copy/Paste Source<a href="#copypaste-source" class="hash-link" aria-label="Direct link to Copy/Paste Source" title="Direct link to Copy/Paste Source">​</a></h2>
<p>最簡單暴力的方式，把仰賴函式庫的 source 跟 header 直接複製到專案的資料夾下，直接編譯進去專案本身。舉例來說 <a href="https://github.com/fogleman/Craft" target="_blank" rel="noopener noreferrer">fogleman/Craft</a> 是屬於這類。</p>
<h2 class="anchor anchorWithStickyNavbar_mpuI" id="native-cmake">Native CMake<a href="#native-cmake" class="hash-link" aria-label="Direct link to Native CMake" title="Direct link to Native CMake">​</a></h2>
<p>在 <a href="https://cmake.org/" target="_blank" rel="noopener noreferrer">CMake</a> 中有個指令 <code>find_library</code> 允許在專案的 config 階段先偵測環境中是否有指定的函式庫，找不到的話就會拋出錯誤。這種專案配置將安裝仰賴函式庫責任交給 host 本身，通常專案的 build guild 會寫著 「先執行 <code>sudo apt install ....</code>」之類的。舉例來說 <a href="https://github.com/LibreSprite/LibreSprite/blob/18e16ef410d410f18c180ec7282861ea61def68f/CMakeLists.txt#L144-L187" target="_blank" rel="noopener noreferrer">LibreSprite</a> 是屬於這類。</p>
<h2 class="anchor anchorWithStickyNavbar_mpuI" id="git">Git<a href="#git" class="hash-link" aria-label="Direct link to Git" title="Direct link to Git">​</a></h2>
<p>利用 Git 的 submodule 功能，把其他 repository 參考到專案中。舉例來說 <a href="https://github.com/cuberite/cuberite/tree/master/lib" target="_blank" rel="noopener noreferrer">Cuberite</a> 是屬於這類。</p>
<h2 class="anchor anchorWithStickyNavbar_mpuI" id="dependencies-tool">Dependencies Tool<a href="#dependencies-tool" class="hash-link" aria-label="Direct link to Dependencies Tool" title="Direct link to Dependencies Tool">​</a></h2>
<p>就像 PHP 有 Composer；Node.js 有 NPM；Python 有 pip；Rust 有 Cargo 一樣，C++ 的開發者們當然也製作了工具來處理專案仰賴函式庫的問題，不過受限於 C++ 的語言特性，目前並沒有一勞永逸的殺手級工具，仍然處於百家爭鳴的狀態。</p>
<ul>
<li><a href="https://github.com/cpm-cmake/CPM.cmake" target="_blank" rel="noopener noreferrer">CPM.cmake</a></li>
<li><a href="https://conan.io/" target="_blank" rel="noopener noreferrer">Conan</a></li>
<li><a href="https://github.com/microsoft/vcpkg" target="_blank" rel="noopener noreferrer">Vcpkg</a></li>
<li><a href="https://github.com/cpp-pm/hunter" target="_blank" rel="noopener noreferrer">Hunter</a></li>
<li><a href="https://buckaroo.pm/" target="_blank" rel="noopener noreferrer">Buckaroo</a></li>
</ul>
<hr>
<p><a href="http://creativecommons.org/licenses/by-sa/4.0/" target="_blank" rel="noopener noreferrer"><img decoding="async" loading="lazy" src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png" alt="創用 CC 授權條款" class="img_RpFt"></a><br>
<!-- -->Wei Ji以<a href="http://creativecommons.org/licenses/by-sa/4.0/" target="_blank" rel="noopener noreferrer">創用CC 姓名標示-相同方式分享 4.0 國際 授權條款</a>釋出。</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_Wp5O padding--none margin-left--sm"><li class="tag_UXKs"><a class="tag_lXMw tagRegular_c460" href="/blog/tags/learning-note">learning note</a></li><li class="tag_UXKs"><a class="tag_lXMw tagRegular_c460" href="/blog/tags/c">c++</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="https://schema.org/BlogPosting"><meta itemprop="description" content="Electron in the frontend roadmap"><header><h2 class="title_BVkY" itemprop="headline"><a itemprop="url" href="/blog/2023-04-01_electron_learning_note_intro">Electron 學習筆記 - 概敘</a></h2><div class="container_sDB1 margin-vert--md"><time datetime="2023-04-01T00:00:00.000Z" itemprop="datePublished">April 1, 2023</time> · <!-- -->3 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_SrKl"><div class="avatar margin-bottom--sm"><a href="https://github.com/FlySkyPie" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars.githubusercontent.com/u/9475660" alt="Wei Ji" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/FlySkyPie" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Wei Ji</span></a></div><small class="avatar__subtitle" itemprop="description">閃亮症候群工程屍</small></div></div></div></div></header><div class="markdown" itemprop="articleBody">
<p><img decoding="async" loading="lazy" alt="Electron in the frontend roadmap" src="/assets/images/electron-in-the-frontend-roadmap-216770b605c3467e5fb83d37d3ee6c1e.webp" width="688" height="300" class="img_RpFt"></p>
<p>Electron 可以說是前端軟體工程師必學的經典工具之一 (2023 年)，也是我個人有興趣學習的主題之一，只是一直缺乏明確的動機或目的去使用它，直到那天 (2023-03-30) 協助友人改善他 Side Project UI，同一天另外一個朋友又剛好問我 Electron 的問題，看來這是要我學習 Electron 的天意啊（？）</p>
<p>稍微試了幾個專案樣板，然後讀了一點官方文件，我稍微整理出它的架構：</p>
<p><img decoding="async" loading="lazy" src="/assets/images/architecture-d21d8d19a8463fb1078ac51cee8db333.svg" width="1450" height="923" class="img_RpFt"></p>
<p>這裡有幾個知識點最好在學習 Electron 之前先知道：</p>
<ul>
<li>Javascript 是一種程式語言，但是它的直譯器不只一種</li>
<li>瀏覽器上的 Javascript 執行環境和 Node.js 的執行環境不同</li>
<li>在瀏覽器上開發者可以用 Javascript 使用 Web API (<code>window.*</code>, <code>CSS</code>, <code>DOM</code>...等)和 ES Module (符合 ES6 規範的 Javascript 模組)</li>
<li>在 Node.js 上開發者可以使用 Node.js 的內建模組 (<code>fs</code>, <code>os</code>, <code>path</code>...等)和 NPM 上提供的 CommonJS Module</li>
<li>在瀏覽器上 Javascript 沒有權限進行一些涉及作業系統的操作，如：對檔案系統進行讀寫</li>
</ul>
<p>然後我整理了幾個關於 Electron 的知識點整理：</p>
<ul>
<li>Electron 應用程式分成兩個區塊<!-- -->
<ul>
<li>瀏覽器（基於 Chromium）</li>
<li>Node.js</li>
</ul>
</li>
<li>兩個區塊彼此獨立<!-- -->
<ul>
<li>Main Process 不能操作 DOM</li>
<li>Render Process 不能使用 Node.js 模組讀寫檔案系統或是 spawn 子行程</li>
</ul>
</li>
<li>一個應用程式可能有複數個視窗</li>
<li>Preload Prcess 能夠同時訪問瀏覽器區塊和 Node.js 區塊<!-- -->
<ul>
<li>我們可以把原本被隔離的兩個區塊曝露部份操作給彼此</li>
<li>透過 Electron 提供的 IPC API</li>
</ul>
</li>
</ul>
<hr>
<p><a href="http://creativecommons.org/licenses/by-sa/4.0/" target="_blank" rel="noopener noreferrer"><img decoding="async" loading="lazy" src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png" alt="創用 CC 授權條款" class="img_RpFt"></a><br>
<!-- -->Wei Ji以<a href="http://creativecommons.org/licenses/by-sa/4.0/" target="_blank" rel="noopener noreferrer">創用CC 姓名標示-相同方式分享 4.0 國際 授權條款</a>釋出。</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_Wp5O padding--none margin-left--sm"><li class="tag_UXKs"><a class="tag_lXMw tagRegular_c460" href="/blog/tags/learning-note">learning note</a></li><li class="tag_UXKs"><a class="tag_lXMw tagRegular_c460" href="/blog/tags/javascript">javascript</a></li><li class="tag_UXKs"><a class="tag_lXMw tagRegular_c460" href="/blog/tags/electron">electron</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="https://schema.org/BlogPosting"><meta itemprop="description" content="前情提要"><header><h2 class="title_BVkY" itemprop="headline"><a itemprop="url" href="/blog/2023-01-17_a-journey-about-2D-skeletal-animation-of-runtime">一場關於 2D Skeletal animation 動畫的 Web Runtime 的旅程</a></h2><div class="container_sDB1 margin-vert--md"><time datetime="2023-01-17T00:00:00.000Z" itemprop="datePublished">January 17, 2023</time> · <!-- -->9 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_SrKl"><div class="avatar margin-bottom--sm"><a href="https://github.com/FlySkyPie" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars.githubusercontent.com/u/9475660" alt="Wei Ji" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/FlySkyPie" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Wei Ji</span></a></div><small class="avatar__subtitle" itemprop="description">閃亮症候群工程屍</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_mpuI" id="前情提要">前情提要<a href="#前情提要" class="hash-link" aria-label="Direct link to 前情提要" title="Direct link to 前情提要">​</a></h2>
<p>如果對我的 Side Project 「底火的芬芳」不清楚的讀者可能需要先閱讀<a href="/blog/2023-01-04_origin-of-gear-redolence">底火的芬芳 - 專案起源</a>才能理解這場旅程是怎麼開始的。而最近 (2022-12-19) 在逛 Github 的時候晃到一個 <a href="https://github.com/neko-gg/gfl-combat-simulator" target="_blank" rel="noopener noreferrer">repo</a>，它是<a href="https://en.wikipedia.org/wiki/Girls%27_Frontline" target="_blank" rel="noopener noreferrer">少女前線</a>這款遊戲的數值模擬器，往程式語言構成一看是用 Typescript 寫的立刻勾起了我的興趣。</p>
<h2 class="anchor anchorWithStickyNavbar_mpuI" id="neko-gggfl-combat-simulator"><code>neko-gg/gfl-combat-simulator</code><a href="#neko-gggfl-combat-simulator" class="hash-link" aria-label="Direct link to neko-gggfl-combat-simulator" title="Direct link to neko-gggfl-combat-simulator">​</a></h2>
<p>2022-12-19 在 Github 上閒逛的時候，看到一個 <a href="https://github.com/neko-gg/gfl-combat-simulator" target="_blank" rel="noopener noreferrer">repo</a>。</p>
<blockquote>
<p>喔啦啦，這不是 Typescript 嗎？
喔啦啦，這不是 React 嗎？
是我的主場呢 = =+</p>
</blockquote>
<p>於是就 <code>clone</code> 下來研究研究。</p>
<p>後來（約 2022-12-20）照著 <code>README.md</code> 的指示：</p>
<div class="language-shell codeBlockContainer_HtHN theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_XzDj"><pre tabindex="0" class="prism-code language-shell codeBlock_Kgad thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_xOgw"><span class="token-line" style="color:#393A34"><span class="token plain">yarn update-resources</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">yarn update-assets</span><br></span></code></pre><div class="buttonGroup_PN__"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_lePV" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_mz7K"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_aySJ"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>找到了 <a href="https://github.com/neko-gg/gfl-combat-simulator/blob/senpai/src/app/data/ResourcesUpdater.ts" target="_blank" rel="noopener noreferrer">ResourcesUpdater</a> 和 <a href="https://github.com/neko-gg/gfl-combat-simulator/blob/senpai/src/app/data/AssetsUpdater.ts" target="_blank" rel="noopener noreferrer">AssetsUpdater</a> 這兩個程式，發現它把遊戲素材放在另外一個 <a href="https://github.com/36base/girlsfrontline-resources" target="_blank" rel="noopener noreferrer">repo</a>。以及會從遊戲官方的 cdn 下載名為 <code>ResData.ab</code> 的檔案，因為不知道是什麼檔案類  型，就用 Hex 瀏覽器打開來看：</p>
<p><img decoding="async" loading="lazy" src="/assets/images/unity-asset-bundle-binary-bbcfbbe578f898920ce7ab41171aa256.webp" width="355" height="260" class="img_RpFt"></p>
<p>啊啦啦，原來是 Unity ResData Bundle。</p>
<p>另外，從 <code>ResourcesUpdater</code> 看到它呼叫了來自 <a href="https://github.com/neko-gg/gfl-combat-simulator/blob/senpai/src/app/data/ChibiUpdater.ts" target="_blank" rel="noopener noreferrer">ChibiUpdater.ts</a> 的方法，稍微研究一下內容發現它使用 Puppeteer 打開一個<a href="https://naganeko.github.io/spine-gif/" target="_blank" rel="noopener noreferrer">網站</a>並做了某些事，不過因為程式碼已經有點過時了，網站已經被移到<a href="https://naganeko.pages.dev" target="_blank" rel="noopener noreferrer">其他地方</a>，DOM 的操作也和原本腳本內的方式有點落差。研究了它使用 Puppeteer 的方式，看得出來目的是取得一張 Chibi 站立的圖片。</p>
<ul>
<li>原始的 Chibi （程式內對人偶的稱呼）檔案是將人偶拆件，並透過組態檔組裝的。</li>
<li>naganeko 的網站能夠上傳 Spine 檔案，並播放動畫。</li>
<li>naganeko 的網站也能下載組裝後的圖檔。</li>
</ul>
<p>試著逆向工程 naganeko 的網站，發現它應該是使用了 Spine 的 Runtime。</p>
<h2 class="anchor anchorWithStickyNavbar_mpuI" id="2d-骨架動畫">2D 骨架動畫<a href="#2d-骨架動畫" class="hash-link" aria-label="Direct link to 2D 骨架動畫" title="Direct link to 2D 骨架動畫">​</a></h2>
<p>在 3D 模型/動畫中，會使用骨架 (Armature) 綁定模型節點，並透過權重、關鍵影格等方式讓模型執行動畫。</p>
<p>透過把模型壓扁，將這種技術應用在 2D 場景就是 2D 骨架動畫，可以解決傳統 Sprite 的一些<a href="#sprite-%E9%99%90%E5%88%B6">限制</a>。另外還有三渲二之類在遊戲開發上常見的手段，不過不在本次題目的討論範圍內。</p>
<h3 class="anchor anchorWithStickyNavbar_mpuI" id="spine">Spine<a href="#spine" class="hash-link" aria-label="Direct link to Spine" title="Direct link to Spine">​</a></h3>
<p><a href="http://esotericsoftware.com/" target="_blank" rel="noopener noreferrer">Spine</a> 是目前極為普及的 2D 骨架動畫 tool chain。用工業建模比喻的話就像 SolidWork，或是美術產業中的 PhotoShop 以及 Illustrator。原因在於其應用端成功的布局，包含 Unity3D, 又或是網頁遊戲開發 Three.js, Phaser, PixiJS...之類的執行環境，有著非常廣泛的 <a href="http://en.esotericsoftware.com/spine-runtimes" target="_blank" rel="noopener noreferrer">Runtime</a> 支援。換句話使用它的產品，佈署目標的選擇十分多元。</p>
<p>然而這個格式終究是商業產品，編輯器本身需要付費，使用者（如：遊戲開發者）也需要購買<a href="#spine-%E6%8E%88%E6%AC%8A">授權</a>。即便有 Runtime 的原始碼，其授權範圍仍不算開源的範疇，對我而言尋找替代方案就很重要了，因為我只是想寫寫 side project。</p>
<h3 class="anchor anchorWithStickyNavbar_mpuI" id="替代方案">替代方案<a href="#替代方案" class="hash-link" aria-label="Direct link to 替代方案" title="Direct link to 替代方案">​</a></h3>
<p>與 Spine 類似的產品還有 <a href="https://creature.kestrelmoon.com/" target="_blank" rel="noopener noreferrer">Creature Animation</a>、<a href="https://rive.app/" target="_blank" rel="noopener noreferrer">Rive</a> 之類的，不過它們跟 Spine 一樣都有一股商業味，自然就排除在我的選項之外了。</p>
<p>往開源的生態系望去，則有 Blender 的生態系內有個名為 <a href="https://github.com/ndee85/coa_tools" target="_blank" rel="noopener noreferrer">COA Tools</a> 的工具能夠製作 2D 動畫。或是 Godot 作為開源的遊戲引擎也有內建的 <a href="https://docs.godotengine.org/en/stable/tutorials/animation/cutout_animation.html" target="_blank" rel="noopener noreferrer">2D 骨架動畫系統</a>。</p>
<p>只是我懶得自己重頭綁骨架跟刷權重，能夠直接用<del>撿到</del>的少女前線檔案轉檔是在好不過了。</p>
<h3 class="anchor anchorWithStickyNavbar_mpuI" id="dragonbones">DragonBones<a href="#dragonbones" class="hash-link" aria-label="Direct link to DragonBones" title="Direct link to DragonBones">​</a></h3>
<p>最後 (2022-12-22) 決定使用 <a href="https://docs.egret.com/dragonbones/en" target="_blank" rel="noopener noreferrer">DragonBones</a> 的格式，雖然編輯軟體本身沒開源而且只能在 Windows 執行，但是至少是免費的而且能夠用 Wine 跑起來。這個工具背後的中國公司的 Tech Stack 算是從 Flash 長出來的，後來往 Javascript 轉型。因此它的 <a href="https://github.com/DragonBones/DragonBonesJS" target="_blank" rel="noopener noreferrer">runtime</a> 支援不少諸如 Three.js Pixi, Phaser 等知名的 Javascript 的套件。</p>
<p>最重要的是，它能夠匯入 Spine 格式的檔案，並輸出成 DragonBones 的格式。~~這樣我就可以直接撿 Chibi 的檔案來用囉～~~還有其他考量就是，如果編輯器也是基於 Javascript 的話，日後逆向工程起來比較容易。</p>
<p><img decoding="async" loading="lazy" src="/assets/images/smile-80f08926f2ee3bb5bbf8f30446881436.webp" width="540" height="360" class="img_RpFt"></p>
<h2 class="anchor anchorWithStickyNavbar_mpuI" id="dragonbonesjs-重構">DragonBonesJS 重構<a href="#dragonbonesjs-重構" class="hash-link" aria-label="Direct link to DragonBonesJS 重構" title="Direct link to DragonBonesJS 重構">​</a></h2>
<p>然而 DragonBonesJS 的 Javascript Runtime 自 2020 就沒有維護了，而且並不支援 ES6 的模組載入方式。從程式碼看得出來它使用的設計是有一個處理事務邏輯的核心，以及針對各種不同套件實作的 Runtime 。因此即便我重構了核心，也無法直接測試，必須選用一個 Runtime 作為測試用途。</p>
<p>原本支援的 Runtime 中，Three.js 是我的目標，但是沒有充足的 Demo code 能夠測試重構，當中的 Phaser 是我有接觸過得遊戲引擎，但是它的<a href="https://github.com/DragonBones/DragonBonesJS/tree/master/Phaser/3.x/src/dragonBones/phaser" target="_blank" rel="noopener noreferrer">實作</a>較為複雜，而 PixiJS 的版本我雖然沒使用過，但是<a href="https://github.com/DragonBones/DragonBonesJS/tree/master/Pixi/4.x/src/dragonBones/pixi" target="_blank" rel="noopener noreferrer">實作</a>比較簡單，只有 4 個檔案，於是重構的任務就拆成了 3 個部份：</p>
<ul>
<li>Core<!-- -->
<ul>
<li>真正處理動畫邏輯的部份</li>
</ul>
</li>
<li>PixiJS Runetime<!-- -->
<ul>
<li>主要是為了完整的 Demo 範例，好測試 Core 的重構運作正不正常</li>
</ul>
</li>
<li>Three.js Runtime<!-- -->
<ul>
<li>目標，因為我想把 Chibi 丟進 3D 的空間中</li>
</ul>
</li>
</ul>
<p>Core 跟 PixiJS Runtime 的重構過程沒什麼好紀錄的，就是要轉換成 ES6 的寫法跟解決 <code>tsconfig</code> 設定不同的問題。Three.js Runtime 的重構過程倒是問題不少。</p>
<h3 class="anchor anchorWithStickyNavbar_mpuI" id="threejs-runtime-重構">Three.js Runtime 重構<a href="#threejs-runtime-重構" class="hash-link" aria-label="Direct link to Three.js Runtime 重構" title="Direct link to Three.js Runtime 重構">​</a></h3>
<p>DragonBones 提供的 Demo 中，只有線性變換的部份（Translate, Rotation, Scale），並沒有包含網格變形，當我匯入 Chibi 的檔案時，得到了破圖的結果：</p>
<p><img decoding="async" loading="lazy" src="/assets/images/glitch-433919c2c301c10f480f1b177486567c.gif" width="252" height="228" class="img_RpFt"></p>
<p>慶幸的是在 issues 撿到野生的 <a href="https://github.com/DragonBones/DragonBonesJS/issues/133" target="_blank" rel="noopener noreferrer">patch</a>。</p>
<p>接著要處理的要件是升級 Three.js 的版本，DragonBones 遺留的程式碼僅支援到 0.89.0，而目前版本 是 0.148.0。升級的過程遇到一個問題是 Three.js 在 0.125.0 的時候棄用了一個名為 Geometry 的物件，而在 DragonBones 的實作中是仰賴這個物件的，即使可以透過 <a href="https://discourse.threejs.org/t/three-geometry-will-be-removed-from-core-with-r125/22401" target="_blank" rel="noopener noreferrer">Legacy Code</a> 拿來使用，卻會有性能問題。</p>
<h3 class="anchor anchorWithStickyNavbar_mpuI" id="重構成果">重構成果<a href="#重構成果" class="hash-link" aria-label="Direct link to 重構成果" title="Direct link to 重構成果">​</a></h3>
<ul>
<li>Runtime Demo<!-- -->
<ul>
<li><a href="https://flyskypie.github.io/dragonbones-pixi/demo/" target="_blank" rel="noopener noreferrer">https://flyskypie.github.io/dragonbones-pixi/demo/</a></li>
</ul>
</li>
<li>Github Repo<!-- -->
<ul>
<li><a href="https://github.com/FlySkyPie/dragonbones-js" target="_blank" rel="noopener noreferrer">https://github.com/FlySkyPie/dragonbones-js</a></li>
<li><a href="https://github.com/FlySkyPie/dragonbones-pixi" target="_blank" rel="noopener noreferrer">https://github.com/FlySkyPie/dragonbones-pixi</a></li>
<li><a href="https://github.com/FlySkyPie/dragonbones-threejs" target="_blank" rel="noopener noreferrer">https://github.com/FlySkyPie/dragonbones-threejs</a></li>
</ul>
</li>
<li>NPM Package<!-- -->
<ul>
<li><a href="https://www.npmjs.com/package/@flyskypie/dragonbones-js" target="_blank" rel="noopener noreferrer">https://www.npmjs.com/package/@flyskypie/dragonbones-js</a></li>
<li><a href="https://www.npmjs.com/package/@flyskypie/dragonbones-pixi" target="_blank" rel="noopener noreferrer">https://www.npmjs.com/package/@flyskypie/dragonbones-pixi</a></li>
<li><a href="https://www.npmjs.com/package/@flyskypie/dragonbones-threejs" target="_blank" rel="noopener noreferrer">https://www.npmjs.com/package/@flyskypie/dragonbones-threejs</a></li>
</ul>
</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_mpuI" id="threejs-chibi-game-sample">Three.js Chibi Game Sample<a href="#threejs-chibi-game-sample" class="hash-link" aria-label="Direct link to Three.js Chibi Game Sample" title="Direct link to Three.js Chibi Game Sample">​</a></h2>
<p>就只是想做個概念驗證：</p>
<ul>
<li>如果我有一個 2D 人偶</li>
<li>放進 3D 空間，像是<a href="https://threejs.org/examples/?q=control#misc_controls_orbit" target="_blank" rel="noopener noreferrer">Three.js 的範例</a></li>
<li>做成類似<a href="https://youtu.be/xXOa4xqtnfE" target="_blank" rel="noopener noreferrer">尼爾：自動人形</a>駭客小遊戲的風格</li>
</ul>
<p><a href="https://youtu.be/lVCbXohxvPQ" target="_blank" rel="noopener noreferrer" title="Three.js Chibi Animation Shoot Game Prototype"><img decoding="async" loading="lazy" src="http://img.youtube.com/vi/lVCbXohxvPQ/0.jpg" alt="" class="img_RpFt"></a></p>
<h2 class="anchor anchorWithStickyNavbar_mpuI" id="註解">註解<a href="#註解" class="hash-link" aria-label="Direct link to 註解" title="Direct link to 註解">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_mpuI" id="sprite-限制">Sprite 限制<a href="#sprite-限制" class="hash-link" aria-label="Direct link to Sprite 限制" title="Direct link to Sprite 限制">​</a></h3>
<p>傳統 Sprite 是透過切換數張點陣圖達到視覺暫留的動畫效果，點陣圖除了繪製費工之外、檔案較大還有幀數受限制等問題。</p>
<p>與之相對的 3D 模型是用點數據構成的，也就是所謂的向量圖檔。透過綁定骨架就重複使用同一張貼圖製作不同的動畫。</p>
<h3 class="anchor anchorWithStickyNavbar_mpuI" id="spine-授權">Spine 授權<a href="#spine-授權" class="hash-link" aria-label="Direct link to Spine 授權" title="Direct link to Spine 授權">​</a></h3>
<p>Spine 的授權規則很哆嗦：</p>
<ul>
<li><a href="http://zh.esotericsoftware.com/spine-editor-license#s2" target="_blank" rel="noopener noreferrer">http://zh.esotericsoftware.com/spine-editor-license#s2</a></li>
<li><a href="https://github.com/EsotericSoftware/spine-runtimes/blob/4.1/LICENSE" target="_blank" rel="noopener noreferrer">https://github.com/EsotericSoftware/spine-runtimes/blob/4.1/LICENSE</a></li>
</ul>
<hr>
<p><a href="http://creativecommons.org/licenses/by-sa/4.0/" target="_blank" rel="noopener noreferrer"><img decoding="async" loading="lazy" src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png" alt="創用 CC 授權條款" class="img_RpFt"></a><br>
<!-- -->Wei Ji以<a href="http://creativecommons.org/licenses/by-sa/4.0/" target="_blank" rel="noopener noreferrer">創用CC 姓名標示-相同方式分享 4.0 國際 授權條款</a>釋出。</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_Wp5O padding--none margin-left--sm"><li class="tag_UXKs"><a class="tag_lXMw tagRegular_c460" href="/blog/tags/development-note">development note</a></li><li class="tag_UXKs"><a class="tag_lXMw tagRegular_c460" href="/blog/tags/the-key-of-huanche">The Key of Huanche</a></li><li class="tag_UXKs"><a class="tag_lXMw tagRegular_c460" href="/blog/tags/gear-redolence">Gear Redolence</a></li><li class="tag_UXKs"><a class="tag_lXMw tagRegular_c460" href="/blog/tags/2-d-animation">2d animation</a></li><li class="tag_UXKs"><a class="tag_lXMw tagRegular_c460" href="/blog/tags/skeletal-animation">skeletal-animation</a></li><li class="tag_UXKs"><a class="tag_lXMw tagRegular_c460" href="/blog/tags/dragon-bones">DragonBones</a></li></ul></div></footer></article><nav class="pagination-nav" aria-label="Blog list page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/blog"><div class="pagination-nav__label">Newer Entries</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/blog/page/3"><div class="pagination-nav__label">Older Entries</div></a></nav></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 FlyPie (Wei Ji)</div></div></div></footer></div>
</body>
</html>