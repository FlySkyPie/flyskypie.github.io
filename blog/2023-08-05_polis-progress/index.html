<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.1.1">
<title data-rh="true">Polis 專案研究進度 | 工程屍 FlyPie 的異想世界</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://flyskypie.github.io/blog/2023-08-05_polis-progress"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:locale" content="zh_tw"><meta data-rh="true" property="og:title" content="Polis 專案研究進度 | 工程屍 FlyPie 的異想世界"><meta data-rh="true" name="description" content="稍微把 Polis 挖坑至今 (2023-08-05) 累積的嘗試做個紀錄。"><meta data-rh="true" property="og:description" content="稍微把 Polis 挖坑至今 (2023-08-05) 累積的嘗試做個紀錄。"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2023-08-05T00:00:00.000Z"><meta data-rh="true" property="article:author" content="https://github.com/FlySkyPie"><meta data-rh="true" property="article:tag" content="Polis,Hakoniwa,The Key of Huanche"><meta data-rh="true" property="og:image" content="https://i.imgur.com/BfkbXOK.png"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://flyskypie.github.io/blog/2023-08-05_polis-progress"><link data-rh="true" rel="alternate" href="https://flyskypie.github.io/blog/2023-08-05_polis-progress" hreflang="en"><link data-rh="true" rel="alternate" href="https://flyskypie.github.io/blog/2023-08-05_polis-progress" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="工程屍 FlyPie 的異想世界 RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="工程屍 FlyPie 的異想世界 Atom Feed">
<link rel="alternate" type="application/json" href="/blog/feed.json" title="工程屍 FlyPie 的異想世界 JSON Feed">




<link rel="alternate" type="application/rss+xml" href="/posts/rss.xml" title="工程屍 FlyPie 的異想世界 RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/posts/atom.xml" title="工程屍 FlyPie 的異想世界 Atom Feed">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.24/dist/katex.min.css" integrity="sha384-odtC+0UGzzFL/6PNoE8rX/SPcQDXBJ+uRepguP4QkPCm2LBxH3FA3y+fKSiJ+AmM" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.4a9022c6.css">
<script src="/assets/js/runtime~main.18c018ee.js" defer="defer"></script>
<script src="/assets/js/main.bac123e5.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_LBgp" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedComponent_RjML themedComponent--light_RyNI"><img src="/img/logo.svg" alt="My Site Logo" class="themedComponent_RjML themedComponent--dark_ntqO"></div><b class="navbar__title text--truncate"></b></a><a class="navbar__item navbar__link" href="/docs/the-key-of-huanche/">專案文件</a><a class="navbar__item navbar__link" href="/blogs">數位手記</a><a class="navbar__item navbar__link" href="/posts">廢文雜談</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/FlySkyPie" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_s2nU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_DonJ colorModeToggle_KBLq"><button class="clean-btn toggleButton_qwn5 toggleButtonDisabled_tRn_" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_bYdl"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_D9Q4"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Cbrq"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_GUBX"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_UgN6 thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_PkUw margin-bottom--md">Recent posts</div><ul class="sidebarItemList_HFnO clean-list"><li class="sidebarItem_NmoJ"><a class="sidebarItemLink_GF4N" href="/blog/2025-07-05_harbor">OCI Image 本地鏡像站遷移之旅</a></li><li class="sidebarItem_NmoJ"><a class="sidebarItemLink_GF4N" href="/blog/2025-04-23_my-homelab">我的 Homelab</a></li><li class="sidebarItem_NmoJ"><a class="sidebarItemLink_GF4N" href="/blog/2025-03-15_opensource-3d-workflow">一種開源工具鏈嘗試，以最近幫風機製作角座為例</a></li><li class="sidebarItem_NmoJ"><a class="sidebarItemLink_GF4N" href="/blog/2024-11-04_blender-anatomy">從 Blender 開始的解剖學筆記 - 骨骼篇 - 啟程</a></li><li class="sidebarItem_NmoJ"><a class="sidebarItemLink_GF4N" href="/blog/2024-08-31_polis-dev-log">Polis 專案研究進度</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="https://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="https://schema.org/BlogPosting"><meta itemprop="description" content="稍微把 Polis 挖坑至今 (2023-08-05) 累積的嘗試做個紀錄。"><header><h1 class="title_BVkY" itemprop="headline">Polis 專案研究進度</h1><div class="container_sDB1 margin-vert--md"><time datetime="2023-08-05T00:00:00.000Z" itemprop="datePublished">August 5, 2023</time> · <!-- -->12 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_SrKl"><div class="avatar margin-bottom--sm"><a href="https://github.com/FlySkyPie" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars.githubusercontent.com/u/9475660" alt="Wei Ji" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/FlySkyPie" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Wei Ji</span></a></div><small class="avatar__subtitle" itemprop="description">閃亮症候群工程屍</small></div></div></div></div></header><div id="__blog-post-container" class="markdown" itemprop="articleBody">
<p>稍微把 Polis 挖坑至今 (2023-08-05) 累積的嘗試做個紀錄。</p>
<h2 class="anchor anchorWithStickyNavbar_mpuI" id="基本概念">基本概念<a href="#基本概念" class="hash-link" aria-label="Direct link to 基本概念" title="Direct link to 基本概念">​</a></h2>
<p><img decoding="async" loading="lazy" src="/assets/images/01_polis-concept-8e1d6be862b17dfeebc30b8d8cdd83ac.webp" width="1080" height="993" class="img_RpFt"></p>
<p>整個開放世界會被拆分成不同的區域，每個區域由獨立的節點 (Polis Node) 負責運算，節點跟節點之間會構成 P2P 網路，形成一個可以橫向擴展的架構，而 Client 端則會在由 Polis Node 構成的 P2P 網路所運算的開放世界中進行漫遊 (Roaming)。其實這種分散式的架構在 ITUGV 的時宜就令我十分著迷，不過那就是另外一段故事了，在這裡稍微提及只是為了讓讀者理解筆者對分散式架構抱有特別的偏好，並且這種構想早就存在於早期的其他專案之中。</p>
<h2 class="anchor anchorWithStickyNavbar_mpuI" id="poc-proof-of-concept">POC (Proof Of Concept)<a href="#poc-proof-of-concept" class="hash-link" aria-label="Direct link to POC (Proof Of Concept)" title="Direct link to POC (Proof Of Concept)">​</a></h2>
<p>雖然 Polis 作為 Hakoniwa 的子專案，目的一樣是為了建造一個程序化生成 Voxel 開放世界，但是 Polis 將會把重點放在兩個目標上：</p>
<ul>
<li>建立 P2P 網路</li>
<li>能夠透過 Client 程式連線</li>
</ul>
<p>因此在 Polis 的第一個原型中，達到這些條件就算成功完成了概念驗證：</p>
<p><img decoding="async" loading="lazy" src="/assets/images/02_POC-c0c7aaf1dd8fb44ae4dcba0c3c5f130b.webp" width="1568" height="1195" class="img_RpFt"></p>
<h2 class="anchor anchorWithStickyNavbar_mpuI" id="2023-05-13--2023-05-26">2023-05-13 ~ 2023-05-26<a href="#2023-05-13--2023-05-26" class="hash-link" aria-label="Direct link to 2023-05-13 ~ 2023-05-26" title="Direct link to 2023-05-13 ~ 2023-05-26">​</a></h2>
<p>在這個階段我想用 Deno 作為實作 Polis Node 的手段，有幾個原因：</p>
<ol>
<li>Typescript 目前是我最熟練的語言。</li>
<li>WebGPU 已經納入 Web API 中，而部份版本的 Deno 已經實作，因此我能使用 Typescript 解決 server side render 的需求，這麼部份是 Node.js 無法達成的。</li>
<li>Deno 內建跨平台編譯 (Cross Compiling)，因此寫一次程式我就能把節點佈署到除了 Linux 以外的 Windows 或是 macOS 上。</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_mpuI" id="網路連接技術">網路連接技術<a href="#網路連接技術" class="hash-link" aria-label="Direct link to 網路連接技術" title="Direct link to 網路連接技術">​</a></h3>
<p>在挖了坑並且對技術棧 (Technology Stack) 有了粗略的方向之後，首先我想先處理 Polis 中最關鍵的問題：</p>
<blockquote>
<p>如何建立 Polis 網路 （P2P 網路）？</p>
</blockquote>
<p>在 2020-03-22 的時候我就有  使用 ZeroMQ 進行過傳輸相關的<a href="https://github.com/FlySkyPie/the-key-of-huanche-recipe/tree/main/src/core/gym/Test_of_Image_Transfer_with_Different_Decode" target="_blank" rel="noopener noreferrer">實驗</a>，也是我在 The Key of Huanche 中一直考慮投入使用的函式庫。直到我因為 Polis 的分散式架構回過頭去翻閱它的官方文件的時候，才發現了一件事：</p>
<blockquote>
<p>And this is the world we’re targeting with ZeroMQ. When we talk of “scale”, we don’t mean hundreds of computers, or even thousands. Think of clouds of tiny smart and perhaps self-replicating machines surrounding every person, filling every space, covering every wall, filling the cracks and eventually, becoming so much a part of us that we get them before birth and they follow us to death. <sup><a href="#user-content-fn-zeromq-8-ba688f" id="user-content-fnref-zeromq-8-ba688f" data-footnote-ref="true" aria-describedby="footnote-label">1</a></sup></p>
</blockquote>
<p>ZeroMQ 在官方文件 <a href="https://zguide.zeromq.org/docs/chapter8/" target="_blank" rel="noopener noreferrer">Chapter 8 - A Framework for Distributed Computing</a> 中描述了他們那野心勃勃的願景，老實說這非常打動我。</p>
<p>然而調查下來，發現 Deno 在這方面並沒有多少函式庫可以使用、專案的活躍度也都很低：</p>
<ul>
<li><a href="https://github.com/jjeffcaii/deno-zeromq" target="_blank" rel="noopener noreferrer">https://github.com/jjeffcaii/deno-zeromq</a></li>
<li><a href="https://github.com/rracariu/deno-jszmq" target="_blank" rel="noopener noreferrer">https://github.com/rracariu/deno-jszmq</a></li>
<li>似乎只有實作 WekSocket</li>
<li><a href="https://github.com/trs/zmq" target="_blank" rel="noopener noreferrer">https://github.com/trs/zmq</a>
<ul>
<li>deno-jszmq 的 fork</li>
</ul>
</li>
<li><a href="https://github.com/lenkan/deno-amqp" target="_blank" rel="noopener noreferrer">https://github.com/lenkan/deno-amqp</a></li>
<li>兼容 RabbitMQ</li>
<li> 只支援 Server-Client 模式</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_mpuI" id="資料傳輸載體">資料傳輸載體<a href="#資料傳輸載體" class="hash-link" aria-label="Direct link to 資料傳輸載體" title="Direct link to 資料傳輸載體">​</a></h3>
<p>Protobuf (Protocol Buffers) 是另外一個我有意投入 The Key of Huanche 使用的 Technology Stack，第一次知道它的存在是工作上使用 Mapbox 的並因此接觸 <a href="https://github.com/mapbox/vector-tile-spec" target="_blank" rel="noopener noreferrer">Mapbox Vector Tile</a> 的時候發現它所使用的資料格式。簡言之就是一種預先定義資料結構後，把資料壓成密度比較高的格式進行傳輸，到達目的地之後再用預先定義的資料結構進行解碼，比起使用 JSON 傳輸可以省下很多頻寬。</p>
<p>然而在 Deno 的生態戲中依然有類似的問題，能選用的函式庫很少、而且專案活躍路很低：</p>
<ul>
<li><a href="https://github.com/soootaleb/ddapps" target="_blank" rel="noopener noreferrer">https://github.com/soootaleb/ddapps</a>
<ul>
<li>Deno distributed applications framework</li>
</ul>
</li>
<li><a href="https://deno.land/x/protobuf_ts@v1.2.2" target="_blank" rel="noopener noreferrer">https://deno.land/x/protobuf_ts@v1.2.2</a>
<ul>
<li><a href="https://github.com/dancrumb/protobuf.ts" target="_blank" rel="noopener noreferrer">https://github.com/dancrumb/protobuf.ts</a></li>
</ul>
</li>
<li><a href="https://deno.land/x/deno_google_protobuf@4.0.0-rc.2" target="_blank" rel="noopener noreferrer">https://deno.land/x/deno_google_protobuf@4.0.0-rc.2</a>
<ul>
<li><a href="https://github.com/marcushultman/deno-google-protobuf" target="_blank" rel="noopener noreferrer">https://github.com/marcushultman/deno-google-protobuf</a></li>
</ul>
</li>
<li><a href="https://pbkit.dev/" target="_blank" rel="noopener noreferrer">https://pbkit.dev/</a>
<ul>
<li><a href="https://deno.land/x/pbkit@v0.0.61" target="_blank" rel="noopener noreferrer">https://deno.land/x/pbkit@v0.0.61</a></li>
<li><a href="https://github.com/pbkit/pbkit" target="_blank" rel="noopener noreferrer">https://github.com/pbkit/pbkit</a></li>
</ul>
</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_mpuI" id="如何分辨序列化資料-protobuf-的型別">如何分辨序列化資料 Protobuf 的型別？<a href="#如何分辨序列化資料-protobuf-的型別" class="hash-link" aria-label="Direct link to 如何分辨序列化資料 Protobuf 的型別？" title="Direct link to 如何分辨序列化資料 Protobuf 的型別？">​</a></h4>
<p>Polis Node 之間的通訊基本上是一個事件系統，而事件的種類千奇百怪，需要的資料結構當然也是五花八門，但是它們之間會使用同一個序列化的通道，接收端街收到一組序列化資料後要怎麼區分 Protobuf 的類型並使用不同的結構來解碼呢？</p>
<p>沒有辦法直接區分，但是可以透過幾個方法解決這個問題<sup><a href="#user-content-fn-protobuf-type-detect-ba688f" id="user-content-fnref-protobuf-type-detect-ba688f" data-footnote-ref="true" aria-describedby="footnote-label">2</a></sup>：</p>
<ul>
<li>定義一個 Protobuf 封裝來夾帶型別資訊<!-- -->
<ul>
<li>用 oneof 封裝 (也被稱作 union)<!-- -->
<ul>
<li><a href="https://stackoverflow.com/a/40040658" target="_blank" rel="noopener noreferrer">https://stackoverflow.com/a/40040658</a></li>
<li><a href="https://protobuf.dev/programming-guides/proto2/#oneof" target="_blank" rel="noopener noreferrer">https://protobuf.dev/programming-guides/proto2/#oneof</a></li>
<li><a href="https://protobuf.dev/programming-guides/proto3/#oneof" target="_blank" rel="noopener noreferrer">https://protobuf.dev/programming-guides/proto3/#oneof</a></li>
</ul>
</li>
<li>將另外一組 proto 封裝成 any 屬性<!-- -->
<ul>
<li><a href="https://protobuf.dev/programming-guides/techniques/#self-description" target="_blank" rel="noopener noreferrer">https://protobuf.dev/programming-guides/techniques/#self-description</a></li>
</ul>
</li>
</ul>
</li>
<li>在 buffer 加入幾個 bytes 的前輟作為辨識符</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_mpuI" id="壓垮-deno-對我的專案而言的最後一根稻草">壓垮 Deno （對我的專案而言）的最後一根稻草<a href="#壓垮-deno-對我的專案而言的最後一根稻草" class="hash-link" aria-label="Direct link to 壓垮 Deno （對我的專案而言）的最後一根稻草" title="Direct link to 壓垮 Deno （對我的專案而言）的最後一根稻草">​</a></h3>
<p>我其實很難找到支援 WebGPU 或是活躍的 WebGL 的 Javascript 函式庫進行 &quot;denolize&quot;。</p>
<p>WebGPU 在那個當下只有 0.04% 的覆蓋率，就算打開先行版 Chrome 的 WebGPU flag 也是充滿破圖，因此鮮少有函式庫有支援 WebGPU。</p>
<p><img decoding="async" loading="lazy" src="/assets/images/03_webgpu-usage-a72772a075cdcaf6b42490f78498faf1.webp" width="797" height="262" class="img_RpFt"></p>
<p>活躍的 Javascript 3D 繪圖函式庫，諸如：Three.js, Babylon.js，即便當下是基於 WebGL 實作，在 WebGPU 逐漸普及下應該也會逐步支援 WebGPU 才對，但是它們多是基於 Canvas 的繪圖方式，而 Deno 環境下的 WebGPU 實作並不包含 Canvas 相關方法。</p>
<p>加上 WebGPU 的 API 在 1.8 被加入 Deno 之後<sup><a href="#user-content-fn-deno-1.8-ba688f" id="user-content-fnref-deno-1.8-ba688f" data-footnote-ref="true" aria-describedby="footnote-label">3</a></sup>，又在 1.32.0 中基於性能考量被移除了<sup><a href="#user-content-fn-deno-1.32.0-ba688f" id="user-content-fnref-deno-1.32.0-ba688f" data-footnote-ref="true" aria-describedby="footnote-label">4</a></sup>。</p>
<p>也就是「在 Deno 中使用 WebGPU」這件是的前景並不樂觀，我可能必須要面對「使用舊版的 Deno 和相對底層的 WebGPU 手刻整個應用」的問題。</p>
<p>Deno 的 Cross Compiling 的能力是真的很吸引我，但是在繪圖跟網路連線兩面不討好的情況下，加上 IDE 在寫 Deno 程式的 時候開發體驗並不好，我決定放棄這條路。</p>
<h2 class="anchor anchorWithStickyNavbar_mpuI" id="2023-05-27--2023-06-11">2023-05-27 ~ 2023-06-11<a href="#2023-05-27--2023-06-11" class="hash-link" aria-label="Direct link to 2023-05-27 ~ 2023-06-11" title="Direct link to 2023-05-27 ~ 2023-06-11">​</a></h2>
<p>在 2022-10-06 的時候我就已經嘗試過把網頁上渲染的 Canvas 畫面壓成 Webp 並透過 WebSocket 傳送給伺服器播放了<sup><a href="#user-content-fn-simple-stream-ba688f" id="user-content-fnref-simple-stream-ba688f" data-footnote-ref="true" aria-describedby="footnote-label">5</a></sup>，但是當時只是寫了 POC 等級的程式，並不能很好的管理每次連線的 Session，因此良好的串流機制就成了我下一個研究目標。</p>
<h3 class="anchor anchorWithStickyNavbar_mpuI" id="串流方案">串流方案<a href="#串流方案" class="hash-link" aria-label="Direct link to 串流方案" title="Direct link to 串流方案">​</a></h3>
<p><img decoding="async" loading="lazy" alt="https://www.wowza.com/wp-content/uploads/latency-continuum-2021-with-protocols-700x300-1.png" src="/assets/images/04_stream-latency-2d1415ec6bf572221ff968e2888a9f31.webp" width="700" height="380" class="img_RpFt"></p>
<p>花了一點時間 (2023-05-27~2023-05-28) 查資料了解有哪些可能的方案能夠實現我的需求：</p>
<ul>
<li>Websocket<!-- -->
<ul>
<li>✅ Web API 十分普及</li>
<li>❌ 需額外處理影像的解碼與渲染，消費更多的運算與延遲</li>
</ul>
</li>
<li>WebRTC<!-- -->
<ul>
<li>✅ Web API 十分普及</li>
<li>✅ 原生設計支援低延遲</li>
<li>❌ 協定複雜</li>
<li>❌ P2P 架構，雖然可能可以透過在伺服器實作底層來欺騙 client 端，但是需付出額外開發成本</li>
</ul>
</li>
<li>WebTransport/QUIC<!-- -->
<ul>
<li>✅ 支援 UDP，可降低延遲</li>
<li>✅ 次世代 API</li>
<li>❌ Web API 尚未普及<!-- -->
<ul>
<li>瀏覽器支援覆蓋率低</li>
<li>Nodejs 僅實驗性支援 QUIC</li>
<li>Deno 尚不支援</li>
</ul>
</li>
</ul>
</li>
<li>HTML5 video tag<!-- -->
<ul>
<li>✅ Web API 十分普及</li>
<li>❌ 高延遲</li>
</ul>
</li>
<li>Video.js</li>
<li>MPEG-DASH<!-- -->
<ul>
<li>✅ 開放的標準</li>
<li>❌ 有點複雜</li>
</ul>
</li>
<li>FLV<!-- -->
<ul>
<li>✅ 歷史性因素，仍有許多資源</li>
<li>❌ 過時</li>
</ul>
</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_mpuI" id="node-media-server">Node-Media-Server<a href="#node-media-server" class="hash-link" aria-label="Direct link to Node-Media-Server" title="Direct link to Node-Media-Server">​</a></h3>
<p><img decoding="async" loading="lazy" src="/assets/images/05_Node-Media-Server-f6c9a6eaf1b0d27f12dc5399fe257ff0.webp" width="1223" height="762" class="img_RpFt"></p>
<p>之後 (2023-06-04) 發現了 <a href="https://github.com/illuspas/Node-Media-Server" target="_blank" rel="noopener noreferrer">Node-Media-Server</a> 這個專案，透過 RTMP (Real-Time Messaging Protocol) 向 Node-Media-Server 串流影像，接著能夠使用 <a href="https://github.com/illuspas/Node-Media-Server-Admin" target="_blank" rel="noopener noreferrer">Node-Media-Server-Admin</a> 打開串流，而且能夠流暢的關閉與重新開啟串流，Session 的管理便是我在 POC 階段所缺失的，並且它能夠使用以 Javascript 撰寫的 code base 對外進行串流，那我只要有辦法用 Javascript 產生 RTMP 流，就能整合成符合我需求的程式。</p>
<p>於是我便試著透過用 Typescript <a href="https://github.com/FlySkyPie/Node-Media-Server-ts" target="_blank" rel="noopener noreferrer">重構專案</a>的方式理解它是如何實現串流推流的。</p>
<h2 class="anchor anchorWithStickyNavbar_mpuI" id="2023-06-11--2023-06-25">2023-06-11 ~ 2023-06-25<a href="#2023-06-11--2023-06-25" class="hash-link" aria-label="Direct link to 2023-06-11 ~ 2023-06-25" title="Direct link to 2023-06-11 ~ 2023-06-25">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_mpuI" id="rtmp">RTMP<a href="#rtmp" class="hash-link" aria-label="Direct link to RTMP" title="Direct link to RTMP">​</a></h3>
<p><img decoding="async" loading="lazy" src="/assets/images/06_RTMP-learning-note-db26060598ed37f00e25f95e196510ad.webp" width="5411" height="4079" class="img_RpFt"></p>
<p>接著我發現單靠程式碼無法理解它解析 RTMP 封包的邏輯，於是我便打開 <a href="https://rtmp.veriskope.com/docs/spec" target="_blank" rel="noopener noreferrer">RTMP 的規範文件</a>並搭配一些教學文章試著理解它，不過大約只讀到 Header 的部份，我就意識到就算我能製造 RTMP 堆流，還是需要把影像做編碼，然而 Javascript 的生態系在做這件事情上有點貧弱，於是我把目光轉而投向 WebRTC。</p>
<p>至於 RTMP 的學習筆記我應該會發到另外一篇獨立的文章去，雖然因為我其實沒有把 Spec 完整看完，發個不完整的筆記感覺怪彆扭的。=w=&quot;</p>
<h2 class="anchor anchorWithStickyNavbar_mpuI" id="2023-06-25--2023-08-05">2023-06-25 ~ 2023-08-05<a href="#2023-06-25--2023-08-05" class="hash-link" aria-label="Direct link to 2023-06-25 ~ 2023-08-05" title="Direct link to 2023-06-25 ~ 2023-08-05">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_mpuI" id="webrtc">WebRTC<a href="#webrtc" class="hash-link" aria-label="Direct link to WebRTC" title="Direct link to WebRTC">​</a></h3>
<p><img decoding="async" loading="lazy" src="/assets/images/07_webrtc-demo-7de5ea33f86178327ce1788fadade79a.webp" width="1308" height="382" class="img_RpFt"></p>
<p>7 月份因為工作上的壓力比較大，加上充滿了親戚過世、Steam 夏季特賣、COSUP...等等事件，所以學習 WebRTC 的進度可以說是其極緩慢，不過終於在昨天 (2023-08-05) 理解如何使用這個 Web API 並把<a href="https://github.com/FlySkyPie/canvas-webrtc-sample" target="_blank" rel="noopener noreferrer">範例</a>做出來了。</p>
<p>同樣的，關於 WebRTC 的學習筆記我會放在另外一篇獨立的文章。</p>
<hr>
<p><a href="http://creativecommons.org/licenses/by-sa/4.0/" target="_blank" rel="noopener noreferrer"><img decoding="async" loading="lazy" src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png" alt="創用 CC 授權條款" class="img_RpFt"></a><br>
<!-- -->Wei Ji 以<a href="http://creativecommons.org/licenses/by-sa/4.0/" target="_blank" rel="noopener noreferrer">創用CC 姓名標示-相同方式分享 4.0 國際 授權條款</a>釋出。</p>
<section data-footnotes="true" class="footnotes"><h2 class="anchor anchorWithStickyNavbar_mpuI sr-only" id="footnote-label">Footnotes<a href="#footnote-label" class="hash-link" aria-label="Direct link to Footnotes" title="Direct link to Footnotes">​</a></h2>
<ol>
<li id="user-content-fn-zeromq-8-ba688f">
<p>Chapter 8 - A Framework for Distributed Computing. Retrieved 2023-08-05, from <a href="https://zguide.zeromq.org/docs/chapter8" target="_blank" rel="noopener noreferrer">https://zguide.zeromq.org/docs/chapter8</a> <a href="#user-content-fnref-zeromq-8-ba688f" data-footnote-backref="" aria-label="Back to reference 1" class="data-footnote-backref">↩</a></p>
</li>
<li id="user-content-fn-protobuf-type-detect-ba688f">
<p>c# - Protocol buffers detect type from raw message - Stack Overflow. Retrieved 2023-08-06, from <a href="https://stackoverflow.com/a/9125119" target="_blank" rel="noopener noreferrer">https://stackoverflow.com/a/9125119</a> <a href="#user-content-fnref-protobuf-type-detect-ba688f" data-footnote-backref="" aria-label="Back to reference 2" class="data-footnote-backref">↩</a></p>
</li>
<li id="user-content-fn-deno-1.8-ba688f">
<p>Deno 1.8 Release Notes. Retrieved 2023-08-05, from <a href="https://deno.com/blog/v1.8" target="_blank" rel="noopener noreferrer">https://deno.com/blog/v1.8</a> <a href="#user-content-fnref-deno-1.8-ba688f" data-footnote-backref="" aria-label="Back to reference 3" class="data-footnote-backref">↩</a></p>
</li>
<li id="user-content-fn-deno-1.32.0-ba688f">
<p>Release v1.32.0 · denoland/deno. Retrieved 2023-08-05, from <a href="https://github.com/denoland/deno/releases/tag/v1.32.0" target="_blank" rel="noopener noreferrer">https://github.com/denoland/deno/releases/tag/v1.32.0</a> <a href="#user-content-fnref-deno-1.32.0-ba688f" data-footnote-backref="" aria-label="Back to reference 4" class="data-footnote-backref">↩</a></p>
</li>
<li id="user-content-fn-simple-stream-ba688f">
<p>Day 22 Streaming POC - iT 邦幫忙::一起幫忙解決難題，拯救 IT 人的一天. Retrieved 2023-08-05, from <a href="https://ithelp.ithome.com.tw/articles/10305097" target="_blank" rel="noopener noreferrer">https://ithelp.ithome.com.tw/articles/10305097</a> <a href="#user-content-fnref-simple-stream-ba688f" data-footnote-backref="" aria-label="Back to reference 5" class="data-footnote-backref">↩</a></p>
</li>
</ol>
</section></div><footer class="row docusaurus-mt-lg blogPostFooterDetailsFull_Dvxa"><div class="col"><b>Tags:</b><ul class="tags_Wp5O padding--none margin-left--sm"><li class="tag_UXKs"><a class="tag_lXMw tagRegular_c460" href="/blog/tags/polis">Polis</a></li><li class="tag_UXKs"><a class="tag_lXMw tagRegular_c460" href="/blog/tags/hakoniwa">Hakoniwa</a></li><li class="tag_UXKs"><a class="tag_lXMw tagRegular_c460" href="/blog/tags/the-key-of-huanche">The Key of Huanche</a></li></ul></div></footer></article><div id="disqus_thread"></div><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/blog/2023-08-07_webrtc-learning-note"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">WebRTC 學習筆記</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/blog/2023-05-14_project-polis"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Polis Project</div></a></nav></main><div class="col col--2"><div class="tableOfContents_OfXd thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#基本概念" class="table-of-contents__link toc-highlight">基本概念</a></li><li><a href="#poc-proof-of-concept" class="table-of-contents__link toc-highlight">POC (Proof Of Concept)</a></li><li><a href="#2023-05-13--2023-05-26" class="table-of-contents__link toc-highlight">2023-05-13 ~ 2023-05-26</a><ul><li><a href="#網路連接技術" class="table-of-contents__link toc-highlight">網路連接技術</a></li><li><a href="#資料傳輸載體" class="table-of-contents__link toc-highlight">資料傳輸載體</a></li><li><a href="#壓垮-deno-對我的專案而言的最後一根稻草" class="table-of-contents__link toc-highlight">壓垮 Deno （對我的專案而言）的最後一根稻草</a></li></ul></li><li><a href="#2023-05-27--2023-06-11" class="table-of-contents__link toc-highlight">2023-05-27 ~ 2023-06-11</a><ul><li><a href="#串流方案" class="table-of-contents__link toc-highlight">串流方案</a></li><li><a href="#node-media-server" class="table-of-contents__link toc-highlight">Node-Media-Server</a></li></ul></li><li><a href="#2023-06-11--2023-06-25" class="table-of-contents__link toc-highlight">2023-06-11 ~ 2023-06-25</a><ul><li><a href="#rtmp" class="table-of-contents__link toc-highlight">RTMP</a></li></ul></li><li><a href="#2023-06-25--2023-08-05" class="table-of-contents__link toc-highlight">2023-06-25 ~ 2023-08-05</a><ul><li><a href="#webrtc" class="table-of-contents__link toc-highlight">WebRTC</a></li></ul></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 FlyPie (Wei Ji)</div></div></div></footer></div>
</body>
</html>